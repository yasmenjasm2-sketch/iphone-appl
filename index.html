<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙÙˆØ§ÙƒÙ‡ - Fawakih AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg: #0f0f13;
            --surface: #1e1e24;
            --text: #ffffff;
            --error: #ff7675;
            --success: #00b894;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            position: relative;
        }

        /* Screens */
        .screen {
            background: var(--surface);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .screen.active {
            display: block;
            opacity: 1;
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Login Elements */
        h1, h2 { margin-bottom: 20px; color: var(--secondary); }
        
        .input-group { margin-bottom: 20px; text-align: right; }
        
        input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #2d2d35;
            color: white;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: 0.3s;
        }

        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:active { transform: scale(0.98); }

        .status-msg {
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
        }
        .error { color: var(--error); }
        .success { color: var(--success); }

        /* Game Elements */
        .fruit-display {
            font-size: 80px;
            margin: 30px 0;
            min-height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 0 15px rgba(108, 92, 231, 0.5));
        }

        .fruit-name {
            font-size: 24px;
            color: #ccc;
            margin-bottom: 30px;
        }

        .magic-circle {
            width: 150px;
            height: 150px;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 30px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .device-id {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: #444;
        }

    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen" class="screen">
            <h1>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h1>
            <p style="margin-bottom: 20px; color: #888;">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            
            <div class="input-group">
                <input type="text" id="license-code" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
            </div>

            <button class="btn" onclick="SubscriptionManager.validate()">Ø¯Ø®ÙˆÙ„</button>
            <div id="login-status" class="status-msg"></div>
            <div class="device-id">Device ID: <span id="did-display"></span></div>
        </div>

        <div id="game-screen" class="screen">
            <h2>Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h2>
            
            <div class="magic-circle" id="loader"></div>
            
            <div id="result-container">
                <div class="fruit-display" id="fruit-icon">â“</div>
                <div class="fruit-name" id="fruit-text">Ø§Ø¶ØºØ· Ù„Ù„ØªØ®Ù…ÙŠÙ†</div>
            </div>

            <button class="btn" id="guess-btn" onclick="GameEngine.predict()">ØªØ®Ù…ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠ</button>
            
            <div style="margin-top: 20px; font-size: 12px; color: #555;">
                Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="days-left">--</span> ÙŠÙˆÙ…
            </div>
            <button onclick="SubscriptionManager.logout()" style="background:none; border:none; color:#555; margin-top:10px; cursor:pointer; font-size:12px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

<script>
/**
 * 1. Security & Device Binding Module
 * Ø­Ù…Ø§ÙŠØ© ÙˆØªÙˆÙ„ÙŠØ¯ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
 */
const Security = {
    getDeviceID: function() {
        let id = localStorage.getItem('fwh_device_id');
        if (!id) {
            // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø²
            id = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
            localStorage.setItem('fwh_device_id', id);
        }
        return id;
    },
    
    // ØªØ´ÙÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    hash: function(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return hash.toString();
    }
};

/**
 * 2. Subscription Manager
 * Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯
 */
const SubscriptionManager = {
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØµØ§Ù„Ø­Ø© (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù‡Ù†Ø§ Ù…Ø­Ø§ÙƒØ§Ø©)
    // Ø§Ù„ÙƒÙˆØ¯: VIP-2024
    validCodes: {
        'VIP-2024': 30, // 30 Days
        'ADMIN-KEY': 365,
        'TEST-CODE': 1
    },

    init: function() {
        document.getElementById('did-display').innerText = Security.getDeviceID();
        const savedSub = JSON.parse(localStorage.getItem('fwh_sub_data') || '{}');
        
        if (savedSub && savedSub.expiry && savedSub.deviceID === Security.getDeviceID()) {
            if (Date.now() < savedSub.expiry) {
                this.showGame(savedSub.expiry);
                return;
            } else {
                localStorage.removeItem('fwh_sub_data'); // Ø­Ø°Ù Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ
            }
        }
        
        document.getElementById('login-screen').classList.add('active');
    },

    validate: function() {
        const input = document.getElementById('license-code').value.trim();
        const status = document.getElementById('login-status');
        const deviceID = Security.getDeviceID();

        if (this.validCodes.hasOwnProperty(input)) {
            // Check if code is already bound to another device (Simulated logic)
            // In a real server, you check DB. Here we bind current session.
            
            const days = this.validCodes[input];
            const expiryTime = Date.now() + (days * 24 * 60 * 60 * 1000);
            
            const subData = {
                code: Security.hash(input), // Store hash only
                expiry: expiryTime,
                deviceID: deviceID
            };

            localStorage.setItem('fwh_sub_data', JSON.stringify(subData));
            
            status.className = 'status-msg success';
            status.innerText = 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!';
            
            setTimeout(() => {
                document.getElementById('login-screen').classList.remove('active');
                this.showGame(expiryTime);
            }, 1000);

        } else {
            status.className = 'status-msg error';
            status.innerText = 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
        }
    },

    showGame: function(expiry) {
        document.getElementById('game-screen').classList.add('active');
        const daysLeft = Math.ceil((expiry - Date.now()) / (1000 * 60 * 60 * 24));
        document.getElementById('days-left').innerText = daysLeft;
        GameEngine.init();
    },

    logout: function() {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.')) {
            localStorage.removeItem('fwh_sub_data');
            location.reload();
        }
    }
};

/**
 * 3. The Core Logic (Ported from Smali)
 * ØªØ­ÙˆÙŠÙ„ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© updateWeightedList Ø¨Ø¯Ù‚Ø©
 */
const GameEngine = {
    fruits: [
        { id: 'apple', name: 'ØªÙØ§Ø­Ø©', icon: 'ğŸ' },
        { id: 'banana', name: 'Ù…ÙˆØ²', icon: 'ğŸŒ' },
        { id: 'orange', name: 'Ø¨Ø±ØªÙ‚Ø§Ù„', icon: 'ğŸŠ' },
        { id: 'grape', name: 'Ø¹Ù†Ø¨', icon: 'ğŸ‡' },
        { id: 'strawberry', name: 'ÙØ±Ø§ÙˆÙ„Ø©', icon: 'ğŸ“' },
        { id: 'watermelon', name: 'Ø¨Ø·ÙŠØ®', icon: 'ğŸ‰' },
        { id: 'cherry', name: 'ÙƒØ±Ø²', icon: 'ğŸ’' }, // Special logic in Smali
        { id: 'mango', name: 'Ù…Ø§Ù†Ø¬Ùˆ', icon: 'ğŸ¥­' }
    ],

    // Local Storage Keys
    KEY_LEARNED: 'aiLearnedFruits',
    KEY_RESET_FULL: 'LastFullResetTime',
    KEY_RESET_LIST: 'LastListResetTime',

    // Smali Constants
    TIME_48H: 172800000, // 0xa4cb800
    TIME_3H: 10800000,   // 0xa4cb80 (Note: Smali hex 0xa4cb80 is ~3 hours, not 24h)

    aiLearnedFruits: [], // History list

    init: function() {
        // Load history
        try {
            this.aiLearnedFruits = JSON.parse(localStorage.getItem(this.KEY_LEARNED) || '[]');
        } catch(e) { this.aiLearnedFruits = []; }
        
        this.checkTimers();
    },

    // Method private updateWeightedList() implementation
    updateWeightedList: function() {
        const weightedFruitViews = [];
        const fruitMap = {}; 
        
        // 1. Initial Fill (Line 81 in Smali)
        this.fruits.forEach(f => {
            fruitMap[f.id] = f;
            weightedFruitViews.push(f); // Add base weight 1
        });

        // 2. Calculate Frequencies (Line 108)
        const frequencyMap = {};
        this.aiLearnedFruits.forEach(fruitId => {
            frequencyMap[fruitId] = (frequencyMap[fruitId] || 0) + 1;
        });

        // 3. Last Item Logic (Line 137)
        let lastFruit = "";
        if (this.aiLearnedFruits.length > 0) {
            lastFruit = this.aiLearnedFruits[this.aiLearnedFruits.length - 1];
        }

        // 4. Weight Calculation Loop (Line 151)
        // Loop max 20 recent items
        const loopLimit = Math.min(this.aiLearnedFruits.length, 20);
        
        for (let i = 0; i < loopLimit; i++) {
            // Get item from end backwards
            const index = this.aiLearnedFruits.length - i - 1;
            const fruitId = this.aiLearnedFruits[index];
            const fruitObj = fruitMap[fruitId];

            if (fruitObj) {
                // Calculate Weight
                // Smali: const/16 v7, 0x12 (18) - i
                let weight = 18 - i;
                if (weight < 2) weight = 2; // Min weight base

                // Add frequency bonus: count * 2, min(result, 12)
                const freq = frequencyMap[fruitId] || 0;
                const freqBonus = Math.min(freq * 2, 12);
                weight += freqBonus;

                // Anti-repetition: if same as last fruit, divide by 3
                if (fruitId === lastFruit) {
                    weight = Math.floor(weight / 3);
                }

                // Cherry Rule (Smali Line 128): if cherry, set weight = 1
                if (fruitId === 'cherry') {
                    weight = 1;
                }

                // Cap at 35 (0x23)
                if (weight > 35) weight = 35;

                // Add to list 'weight' times
                for (let k = 0; k < weight; k++) {
                    weightedFruitViews.push(fruitObj);
                }
            }
        }

        // Shuffle (Line 149)
        for (let i = weightedFruitViews.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [weightedFruitViews[i], weightedFruitViews[j]] = [weightedFruitViews[j], weightedFruitViews[i]];
        }

        return weightedFruitViews;
    },

    checkTimers: function() {
        const now = Date.now();
        const lastFull = parseInt(localStorage.getItem(this.KEY_RESET_FULL) || '0');
        const lastList = parseInt(localStorage.getItem(this.KEY_RESET_LIST) || '0');

        // Check 48h Full Reset
        if (now - lastFull > this.TIME_48H) {
            this.aiLearnedFruits = [];
            localStorage.setItem(this.KEY_LEARNED, JSON.stringify(this.aiLearnedFruits));
            localStorage.setItem(this.KEY_RESET_FULL, now);
            console.log("Memory Reset (48h)");
        }
        // Check 3h Aging (Halve list)
        else if (now - lastList > this.TIME_3H) { // Using 0xa4cb80 from Smali
            if (this.aiLearnedFruits.length > 0) {
                const half = Math.floor(this.aiLearnedFruits.length / 2);
                this.aiLearnedFruits.splice(0, half); // Remove first half
                localStorage.setItem(this.KEY_LEARNED, JSON.stringify(this.aiLearnedFruits));
            }
            localStorage.setItem(this.KEY_RESET_LIST, now);
            console.log("Memory Aging");
        }
    },

    predict: function() {
        const btn = document.getElementById('guess-btn');
        const icon = document.getElementById('fruit-icon');
        const text = document.getElementById('fruit-text');
        const loader = document.getElementById('loader');
        const resultCont = document.getElementById('result-container');

        // UI Animation
        btn.disabled = true;
        resultCont.style.display = 'none';
        loader.style.display = 'block';

        // Simulation Delay
        setTimeout(() => {
            // Run Logic
            this.checkTimers();
            const weightedList = this.updateWeightedList();
            
            // Pick Winner
            const winnerIndex = Math.floor(Math.random() * weightedList.length);
            const winner = weightedList[winnerIndex];

            // Update History
            this.aiLearnedFruits.push(winner.id);
            localStorage.setItem(this.KEY_LEARNED, JSON.stringify(this.aiLearnedFruits));

            // Show Result
            loader.style.display = 'none';
            resultCont.style.display = 'block';
            icon.innerText = winner.icon;
            text.innerText = winner.name;
            
            // Add pop animation
            icon.style.animation = 'none';
            icon.offsetHeight; /* trigger reflow */
            icon.style.animation = 'slideUp 0.3s ease';

            btn.disabled = false;
        }, 1500); // 1.5s delay for effect
    }
};

// Start App
window.onload = function() {
    SubscriptionManager.init();
};

</script>
</body>
</html>
