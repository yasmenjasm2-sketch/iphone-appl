<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø´Ø§Øª Ø¨Ù„Ø³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
<style>
    /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… --- */
    :root {
        --bg-dark: #0a0a0a;
        --bg-panel: #141414;
        --accent-color: #00bcd4; /* Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ */
        --accent-glow: rgba(0, 188, 212, 0.4);
        --text-main: #ececec;
        --text-secondary: #aaaaaa;
        --msg-bg-me: #006064;
        --msg-bg-other: #1e1e1e;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
        background-color: var(--bg-dark);
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(30, 30, 30, 0.8) 0%, transparent 40%),
            radial-gradient(circle at 90% 80%, rgba(20, 20, 20, 0.8) 0%, transparent 40%);
        color: var(--text-main);
        font-family: 'Tajawal', sans-serif;
        margin: 0; padding: 0;
        height: 100vh;
        overflow: hidden;
        display: flex; justify-content: center; align-items: center;
    }

    /* --- Ø§Ù„Ø­Ø±ÙƒØ§Øª (Animations) --- */
    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(30px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes pulseGlow {
        0% { box-shadow: 0 0 5px var(--accent-glow); }
        50% { box-shadow: 0 0 15px var(--accent-glow); }
        100% { box-shadow: 0 0 5px var(--accent-glow); }
    }

    /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    #login-screen {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(15px);
        padding: 40px 30px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08);
        width: 100%; max-width: 380px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        animation: slideUpFade 0.6s ease-out;
        z-index: 100;
    }

    #login-screen h2 { margin-bottom: 30px; color: var(--accent-color); font-weight: 800; letter-spacing: 1px; text-shadow: 0 0 10px var(--accent-glow); }

    .input-group { position: relative; margin-bottom: 15px; }
    
    .login-input { 
        width: 100%; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid #333;
        color: white; border-radius: 12px; font-size: 14px; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }

    /* Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØµØµ */
    .file-upload-wrapper {
        position: relative; margin: 15px 0;
        background: rgba(255,255,255,0.05); border: 1px dashed #555;
        border-radius: 12px; padding: 20px; cursor: pointer;
        transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .file-upload-wrapper:hover { border-color: var(--accent-color); background: rgba(0, 188, 212, 0.05); }
    .file-upload-wrapper span { font-size: 0.9em; color: #888; margin-top: 5px; }
    
    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
    #preview-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); margin-bottom: 10px; display: none; }

    .btn-main { 
        width: 100%; padding: 15px; margin-top: 10px;
        background: linear-gradient(135deg, #0097a7, #006064);
        color: white; border: none; border-radius: 12px;
        font-weight: bold; cursor: pointer; font-size: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-main:active { transform: scale(0.98); }

    /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª --- */
    #chat-screen {
        display: none; width: 100%; height: 100%;
        background: #000;
        flex-direction: column;
        animation: slideUpFade 0.5s ease;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .chat-header {
        height: 65px;
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #222;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px;
        z-index: 10;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .app-title { font-weight: 800; font-size: 1.2rem; color: var(--accent-color); }
    .header-controls input {
        background: #111; border: 1px solid #333; color: white;
        padding: 6px 12px; border-radius: 20px; font-size: 12px; width: 120px; text-align: center;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #chat-box {
        flex: 1; overflow-y: auto; padding: 20px;
        background-image: 
            linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
            url('https://www.transparenttextures.com/patterns/dark-matter.png');
        scroll-behavior: smooth;
    }
    
    /* Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .msg-row {
        display: flex; margin-bottom: 15px; align-items: flex-end;
        animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .msg-row.me { flex-direction: row-reverse; }

    .msg-avatar {
        width: 38px; height: 38px; border-radius: 50%;
        object-fit: cover; border: 2px solid #222;
        margin: 0 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .msg-content {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 18px;
        position: relative;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .msg-row.other .msg-content {
        background: var(--msg-bg-other);
        border-bottom-right-radius: 18px;
        border-bottom-left-radius: 4px;
        border: 1px solid #333;
    }
    .msg-row.me .msg-content {
        background: var(--msg-bg-me);
        color: white;
        border-bottom-left-radius: 18px;
        border-bottom-right-radius: 4px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .msg-name { font-size: 11px; font-weight: bold; margin-bottom: 4px; display: block; opacity: 0.8; color: var(--accent-color); }
    .msg-time { font-size: 9px; opacity: 0.6; display: block; margin-top: 5px; text-align: left; }
    .msg-img-content { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„) */
    .chat-footer {
        padding: 10px 15px;
        background: #141414;
        border-top: 1px solid #222;
        display: flex; align-items: center; gap: 10px;
    }
    
    .input-container {
        flex: 1; position: relative;
        background: #252525; border-radius: 25px;
        display: flex; align-items: center; padding: 5px 15px;
        border: 1px solid #333; transition: 0.3s;
    }
    .input-container:focus-within { border-color: var(--accent-color); background: #2a2a2a; }
    
    #msg-input {
        flex: 1; background: transparent; border: none; color: white;
        padding: 10px; font-size: 14px;
    }
    
    .btn-icon {
        background: none; border: none; cursor: pointer; font-size: 20px;
        color: #888; transition: 0.2s; padding: 5px;
    }
    .btn-icon:hover { color: white; }
    
    .btn-send {
        background: var(--accent-color); color: white;
        width: 45px; height: 45px; border-radius: 50%;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 188, 212, 0.3);
        transition: 0.3s;
    }
    .btn-send:hover { transform: scale(1.1) rotate(-10deg); box-shadow: 0 0 15px var(--accent-glow); }
    .btn-send svg { width: 20px; height: 20px; fill: white; transform: translateX(-2px); }

    /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) --- */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 998; display: none; backdrop-filter: blur(5px); }
    #profileModal {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
        background: #181818; border: 1px solid #333;
        width: 90%; max-width: 320px;
        padding: 30px; border-radius: 20px;
        z-index: 999; display: none; text-align: center;
        box-shadow: 0 0 50px rgba(0,0,0,1);
        transition: 0.3s; opacity: 0;
    }
    #profileModal.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }

    .modal-img-large { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent-color); margin-bottom: 15px; object-fit: cover; }
    .modal-info h3 { margin: 0; color: white; }
    .modal-info p { color: #666; font-family: monospace; background: #111; display: inline-block; padding: 4px 10px; border-radius: 5px; margin-top: 5px; }
    
    /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† */
    .admin-tools { margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; display: none; }
    .ban-btn { background: #d32f2f; color: white; width: 100%; padding: 10px; border: none; border-radius: 8px; cursor: pointer; margin-top: 5px; }

</style>
</head>
<body>

<div id="login-screen">
    <h2>Chat Plus âš¡</h2>
    
    <div class="input-group">
        <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User ID)">
    </div>
    <div class="input-group">
        <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    
    <hr style="border-color: #333; margin: 20px 0; opacity: 0.3;">
    
    <div class="input-group">
        <input type="text" id="realName" class="login-input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± ÙÙŠ Ø§Ù„Ø´Ø§Øª">
    </div>
    
    <div class="file-upload-wrapper" onclick="document.getElementById('profilePicInput').click()">
        <img id="preview-avatar" src="">
        <span id="upload-text">ğŸ“¸ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
        <input type="file" id="profilePicInput" hidden accept="image/*" onchange="handleProfilePicSelect(this)">
    </div>
    
    <button class="btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</button>
</div>

<div id="chat-screen">
    <div class="chat-header">
        <div class="app-title">Chat<span style="color:white; font-weight:300;">Plus</span></div>
        <div class="header-controls">
            <input id="searchId" placeholder="Ø¨Ø­Ø« ID..." oninput="filterMessages()">
            <button onclick="location.reload()" style="background:none; border:none; color:#ff4444; font-size:18px; cursor:pointer;">âœ•</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="chat-footer">
        <button class="btn-icon" onclick="document.getElementById('msgImgInput').click()">ğŸ“·</button>
        <input type="file" id="msgImgInput" hidden accept="image/*">
        
        <div class="input-container">
            <input id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off">
        </div>
        
        <button class="btn-send" onclick="sendTextMsg()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="profileModal">
    <button onclick="closeModal()" style="position:absolute; top:15px; left:15px; background:none; border:none; color:#666; font-size:20px; cursor:pointer;">âœ•</button>
    
    <img id="pModalImg" class="modal-img-large" src="">
    <div class="modal-info">
        <h3 id="pModalName"></h3>
        <p id="pModalId"></p>
    </div>

    <div id="adminPanel" class="admin-tools">
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="number" id="banDuration" placeholder="Ø§Ù„Ù…Ø¯Ø©" style="width:50%; background:#222; border:1px solid #444; color:white; padding:8px; border-radius:5px;">
            <select id="banUnit" style="background:#222; border:1px solid #444; color:white; padding:5px; border-radius:5px;">
                <option value="hours">Ø³Ø§Ø¹Ø§Øª</option>
                <option value="seconds">Ø«ÙˆØ§Ù†ÙŠ</option>
            </select>
        </div>
        <button class="ban-btn" onclick="executeBan()">ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdbUK04WTiBvv3z1K9oYhssfpJTI9fZh4",
    authDomain: "chatdoy.firebaseapp.com",
    databaseURL: "https://chatdoy-default-rtdb.firebaseio.com",
    projectId: "chatdoy",
    storageBucket: "chatdoy.firebasestorage.app",
    messagingSenderId: "922018470576",
    appId: "1:922018470576:web:bbe06151c06e345c4cb975",
    measurementId: "G-6V7VB06ZPL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "messages");
  const bansRef = ref(db, "bans");
  const usersRef = ref(db, "users");

  let myUser = { username: "", displayName: "", photo: "", uid: "", isAdmin: false };
  let tempProfilePicBase64 = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  let selectedUserProfile = null;

  // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØµÙˆØ± (Canvas Compression) ---
  // ÙˆØ¸ÙŠÙØ© Ù„Ø¶ØºØ· ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64 Ø­ØªÙ‰ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø­Ø¬Ù…Ù‡Ø§ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹
  function compressImage(file, maxWidth, quality, callback) {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = event => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
              const canvas = document.createElement('canvas');
              const ratio = maxWidth / img.width;
              canvas.width = maxWidth;
              canvas.height = img.height * ratio;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              // Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© Base64 Ù…Ø¶ØºÙˆØ·Ø©
              callback(canvas.toDataURL('image/jpeg', quality));
          };
      };
  }

  // --- 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---
  window.handleProfilePicSelect = (input) => {
      if (input.files && input.files[0]) {
          // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙƒÙˆÙ† ØµØºÙŠØ±Ø© (Ø±Ù…Ø²ÙŠØ©) 150px
          compressImage(input.files[0], 150, 0.7, (base64) => {
              tempProfilePicBase64 = base64;
              const preview = document.getElementById('preview-avatar');
              preview.src = base64;
              preview.style.display = 'block';
              document.getElementById('upload-text').style.display = 'none';
          });
      }
  };

  // --- 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
  window.login = async () => {
      const uUser = document.getElementById("username").value.trim();
      const uPass = document.getElementById("password").value.trim();
      const uRealName = document.getElementById("realName").value.trim();

      if(!uUser || !uPass) { alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }

      // Ø£Ø¯Ù…Ù†
      if (uUser === "texn") {
          if (uPass === "hamzagmail34567") {
              startChat("texn", "ğ‘ğ„ğŒğ€ğ’ à¼—", "https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg", "1111", true);
          } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£"); }
          return;
      }

      const userNode = child(usersRef, uUser);
      const snap = await get(userNode);
      const defaultPic = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

      if (snap.exists()) {
          const data = snap.val();
          if (data.password === uPass) {
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§
              const finalName = uRealName || data.displayName;
              // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
              const finalPhoto = tempProfilePicBase64 || data.photo || defaultPic;
              
              if(uRealName || tempProfilePicBase64) {
                  set(child(usersRef, uUser + "/displayName"), finalName);
                  set(child(usersRef, uUser + "/photo"), finalPhoto);
              }
              startChat(uUser, finalName, finalPhoto, data.uid, false);
          } else { alert("â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
      } else {
          // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
          if(!uRealName) { alert("ğŸ“ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©"); return; }
          const newUid = Math.floor(1000000000 + Math.random() * 9000000000).toString();
          const finalPhoto = tempProfilePicBase64 || defaultPic;

          await set(userNode, { password: uPass, uid: newUid, displayName: uRealName, photo: finalPhoto });
          startChat(uUser, uRealName, finalPhoto, newUid, false);
      }
  };

  function startChat(username, realName, photo, uid, isAdmin) {
      myUser = { username, displayName: realName, photo, uid, isAdmin };
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("chat-screen").style.display = "flex";
      onChildAdded(chatRef, renderMessage);
  }

  // --- 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
  window.sendTextMsg = async () => {
      const input = document.getElementById("msg-input");
      if(input.value.trim()) {
          await sendMessage(input.value.trim(), null);
          input.value = "";
          input.focus();
      }
  };

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
  document.getElementById("msg-input").addEventListener("keydown", (e) => {
      if(e.key === "Enter") window.sendTextMsg();
  });

  // Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
  document.getElementById("msgImgInput").addEventListener("change", function() {
      if(this.files[0]) {
          // Ø¶ØºØ· ØµÙˆØ± Ø§Ù„Ø´Ø§Øª (Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹) 400px
          compressImage(this.files[0], 400, 0.7, async (base64) => {
             await sendMessage(null, base64);
          });
      }
      this.value = "";
  });

  async function sendMessage(text, imgBase64) {
      // ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±
      const banCheck = await get(child(bansRef, myUser.uid));
      if (banCheck.exists()) {
          if (banCheck.val().until > Date.now()) { alert("â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ø¤Ù‚ØªØ§Ù‹"); return; }
      }

      push(chatRef, {
        senderName: myUser.displayName,
        senderPhoto: myUser.photo,
        uid: myUser.uid,
        isAdmin: myUser.isAdmin,
        text: text,
        image: imgBase64,
        type: "msg",
        time: Date.now()
      });
  }

  // --- 4. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
  function renderMessage(snap) {
      const d = snap.val();
      const chatBox = document.getElementById("chat-box");
      const div = document.createElement("div");
      div.dataset.uid = d.uid;

      if (d.type === "system") {
          div.style.textAlign = "center";
          div.style.margin = "10px 0";
          div.innerHTML = `<span style="background:rgba(255,0,0,0.2); color:#ff8a80; padding:5px 10px; border-radius:5px; font-size:12px;">ğŸ”” ${d.text}</span>`;
      } else {
          const isMe = d.uid === myUser.uid;
          div.className = `msg-row ${isMe ? 'me' : 'other'}`;
          
          const time = new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          const nameColor = d.isAdmin ? '#ff4444' : 'var(--accent-color)';
          const nameText = d.isAdmin ? `ğŸ‘‘ ${d.senderName}` : d.senderName;
          
          let content = "";
          if(d.text) content += `<div>${d.text}</div>`;
          if(d.image) content += `<img src="${d.image}" class="msg-img-content" onclick="window.open(this.src)">`;

          div.innerHTML = `
            <img class="msg-avatar" src="${d.senderPhoto}" onclick="showProfile('${d.senderName}', '${d.senderPhoto}', '${d.uid}')">
            <div class="msg-content">
                <span class="msg-name" style="color:${nameColor}">${nameText}</span>
                ${content}
                <span class="msg-time">${time}</span>
            </div>
          `;
      }
      
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      filterMessages();
  }

  // --- 5. Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„Ø£Ø¯Ù…Ù† ---
  window.showProfile = (name, photo, uid) => {
      selectedUserProfile = { name, uid };
      document.getElementById("pModalImg").src = photo;
      document.getElementById("pModalName").innerText = name;
      document.getElementById("pModalId").innerText = "ID: " + uid;
      
      const panel = document.getElementById("adminPanel");
      // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†ØŒ ÙˆÙ„Ø§ ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ ÙØªØ­Øª Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ Ø£Ùˆ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      if(myUser.isAdmin && uid !== myUser.uid && uid !== "1111") {
          panel.style.display = "block";
      } else {
          panel.style.display = "none";
      }

      const modal = document.getElementById("profileModal");
      const overlay = document.getElementById("overlay");
      overlay.style.display = "block";
      modal.style.display = "block";
      setTimeout(() => modal.classList.add("active"), 10);
  };

  window.closeModal = () => {
      const modal = document.getElementById("profileModal");
      const overlay = document.getElementById("overlay");
      modal.classList.remove("active");
      setTimeout(() => {
          modal.style.display = "none";
          overlay.style.display = "none";
      }, 300);
  };

  window.executeBan = () => {
      const duration = document.getElementById("banDuration").value;
      const unit = document.getElementById("banUnit").value;
      if(!duration) return;
      
      let ms = duration * 1000;
      if(unit === "hours") ms = ms * 60 * 60;
      
      const liftTime = Date.now() + ms;
      
      push(chatRef, { text: `â›” ØªÙ… Ø­Ø¸Ø± ${selectedUserProfile.name} Ù„Ù…Ø¯Ø© ${duration} ${unit === 'hours'?'Ø³Ø§Ø¹Ø©':'Ø«Ø§Ù†ÙŠØ©'}`, type: "system", uid: "0000" });
      set(child(bansRef, selectedUserProfile.uid), { until: liftTime, reason: "Admin Ban" });
      
      window.closeModal();
  };

  window.filterMessages = () => {
      const q = document.getElementById("searchId").value;
      document.querySelectorAll("#chat-box > div").forEach(div => {
          if(!q) div.style.display = "flex";
          else div.style.display = (div.dataset.uid && div.dataset.uid.includes(q)) ? "flex" : "none";
      });
  };
</script>

</body>
</html>
