<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ChatPlus - VIP Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-dark: #050505;
        --panel-bg: #111;
        --accent-color: #00e5ff;
        --gold-grad: linear-gradient(45deg, #FFD700, #FDB931, #FFD700);
        --vip-grad: linear-gradient(90deg, #ff00cc, #333399, #00e5ff);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
        background-color: var(--bg-dark); 
        color: #fff; font-family: 'Tajawal', sans-serif; margin: 0; 
        height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
    }

    /* --- Animations --- */
    @keyframes shine { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
    @keyframes borderPulse { 0% {box-shadow: 0 0 5px #ff00cc;} 50% {box-shadow: 0 0 15px #00e5ff;} 100% {box-shadow: 0 0 5px #ff00cc;} }

    /* --- Login Screen --- */
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 200;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        backdrop-filter: blur(10px);
    }
    .login-box {
        background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px;
        text-align: center; border: 1px solid #333;
    }
    .inp-field {
        width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #444;
        background: #222; color: white; font-family: inherit;
    }
    .btn-main {
        width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold;
        background: linear-gradient(135deg, #00bcd4, #006064); color: white; cursor: pointer; margin-top: 10px;
    }

    /* --- Header --- */
    .chat-header {
        height: 60px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333;
        display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
    }
    .premium-link {
        background: var(--gold-grad); color: #000; padding: 5px 12px; border-radius: 20px;
        font-size: 11px; font-weight: 800; text-decoration: none; display: flex; align-items: center; gap: 5px;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); animation: shine 3s infinite linear; background-size: 200%;
    }

    /* --- Chat Area --- */
    #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #000; }
    
    .msg-row { display: flex; margin-bottom: 15px; align-items: flex-end; }
    .msg-row.me { flex-direction: row-reverse; }
    
    .msg-avatar { width: 38px; height: 38px; border-radius: 50%; margin: 0 8px; border: 2px solid #333; object-fit: cover; }
    
    .msg-bubble {
        max-width: 75%; padding: 10px 14px; border-radius: 16px; position: relative;
        background: #1e1e1e; font-size: 14px; line-height: 1.5;
    }
    .msg-row.me .msg-bubble { background: #006064; color: white; border-bottom-right-radius: 2px; }
    .msg-row.other .msg-bubble { border-bottom-left-radius: 2px; }

    /* --- Premium Message Styles --- */
    .msg-bubble.premium {
        background: linear-gradient(135deg, #1a0b2e, #000);
        border: 1px solid transparent;
        position: relative;
        animation: borderPulse 4s infinite;
    }
    .msg-bubble.premium::before {
        content: ''; position: absolute; inset: -2px; border-radius: 18px; 
        padding: 2px; background: var(--vip-grad); 
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    
    .vip-badge {
        background: var(--vip-grad); -webkit-background-clip: text; color: transparent;
        font-weight: 900; font-size: 10px; margin-right: 5px; text-transform: uppercase; letter-spacing: 1px;
    }
    .id-tag {
        background: #333; color: #aaa; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 5px;
    }
    .vip-id-text {
        font-family: monospace; font-weight: bold; color: #00e5ff; font-size: 10px;
    }

    /* --- Footer --- */
    .chat-footer { padding: 10px; background: #111; border-top: 1px solid #222; display: flex; gap: 10px; }
    #msg-input { flex: 1; background: #222; border: none; padding: 12px; border-radius: 25px; color: white; }
    .btn-send { width: 45px; height: 45px; border-radius: 50%; border: none; background: #00bcd4; cursor: pointer; font-size: 18px; }

    /* --- Admin & Profile Modal --- */
    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #181818; width: 90%; max-width: 350px; padding: 20px; border-radius: 15px; border: 1px solid #333; text-align: center; }
    
    .admin-section { border-top: 1px solid #d32f2f; margin-top: 15px; padding-top: 10px; display: none; }
    .admin-title { color: #d32f2f; font-weight: bold; margin-bottom: 10px; display: block; }
    .search-result { background: #222; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 12px; text-align: right; display: none; }

</style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--accent-color); margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="text" id="logUser" class="inp-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Unique ID)">
        <input type="password" id="logPass" class="inp-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <input type="text" id="logName" class="inp-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±">
        <button onclick="login()" class="btn-main">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª</button>
    </div>
</div>

<!-- Main App -->
<div class="chat-header">
    <div style="font-weight:800; font-size:18px;">Chat<span style="color:var(--accent-color)">Plus</span></div>
    <div style="display: flex; gap: 10px; align-items: center;">
        <button id="adminBtn" onclick="openAdmin()" style="display:none; background:#d32f2f; color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer; font-size:12px;">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
        <a href="premium.html" class="premium-link">
            <span>ğŸ‘‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù…ÙŠØ²</span>
        </a>
        <img id="myAvatar" src="" style="width:35px; height:35px; border-radius:50%; border:1px solid #444;" onclick="openProfile(myUser)">
    </div>
</div>

<div id="chat-box"></div>

<div class="chat-footer">
    <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button onclick="sendMsg()" class="btn-send">â¤</button>
</div>

<!-- Universal Modal (Profile & Admin) -->
<div id="modal-overlay">
    <div class="modal-content">
        <button onclick="closeModal()" style="float:left; background:none; border:none; color:white; font-size:20px;">âœ•</button>
        
        <!-- Profile View -->
        <div id="profileView">
            <img id="pImg" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--accent-color); object-fit: cover;">
            <h3 id="pName" style="margin:5px 0;"></h3>
            <div id="pIdBox" style="font-size:12px; color:#888; margin-bottom:10px;"></div>
            <p id="pBio" style="color:#aaa; font-style:italic; font-size:13px;"></p>
        </div>

        <!-- Admin Control Panel -->
        <div id="adminPanel" class="admin-section">
            <span class="admin-title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</span>
            
            <input id="searchInp" class="inp-field" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… (ID Ø£Ùˆ CustomID)">
            <button onclick="searchUser()" class="btn-main" style="background:#444; padding:8px;">Ø¨Ø­Ø«</button>
            
            <div id="searchRes" class="search-result">
                <div>Ø§Ù„Ø§Ø³Ù…: <span id="resName" style="color:#fff"></span></div>
                <div>Ø§Ù„Ù…Ø¹Ø±Ù: <span id="resUid" style="color:#aaa"></span></div>
                <div>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="resStatus"></span></div>
                <button onclick="banUser()" style="width:100%; background:#d32f2f; color:white; border:none; padding:5px; margin-top:5px; cursor:pointer;">â›” Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
        </div>

        <!-- Edit Profile (Self) -->
        <div id="editSelf" style="display:none; margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <input id="editBio" class="inp-field" placeholder="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§ÙŠÙˆ...">
            <input id="editPhoto" class="inp-field" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
            <button onclick="saveProfile()" class="btn-main" style="font-size:12px; padding:8px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, get, child, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyDdbUK04WTiBvv3z1K9oYhssfpJTI9fZh4", authDomain: "chatdoy.firebaseapp.com", databaseURL: "https://chatdoy-default-rtdb.firebaseio.com", projectId: "chatdoy", storageBucket: "chatdoy.firebasestorage.app", messagingSenderId: "922018470576", appId: "1:922018470576:web:bbe06151c06e345c4cb975" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let myUser = null;
    let targetUserKey = null; // For admin actions

    // --- Login & Init ---
    window.login = async () => {
        const u = document.getElementById("logUser").value.trim().toLowerCase();
        const p = document.getElementById("logPass").value;
        const n = document.getElementById("logName").value;

        if(!u || !p) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        // Admin Hardcoded Login
        if(u === "texn" && p === "hamzagmail34567") {
            myUser = { username: "texn", displayName: "ğ€ğƒğŒğˆğ", uid: "000", photo: "https://i.ibb.co/C0k30bM/admin.png", isAdmin: true, isPremium: true, customID: "BOSS" };
            finalizeLogin();
            return;
        }

        const userRef = ref(db, "users/" + u);
        const snap = await get(userRef);

        if(snap.exists()) {
            const data = snap.val();
            if(data.password !== p) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
            myUser = { ...data, username: u };
            // Update name if changed
            if(n && n !== data.displayName) update(userRef, { displayName: n });
        } else {
            if(!n) return alert("Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±");
            const newUid = Math.floor(100000 + Math.random() * 900000).toString();
            myUser = { username: u, password: p, displayName: n, uid: newUid, photo: "https://cdn-icons-png.flaticon.com/512/149/149071.png", bio: "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", isPremium: false };
            await set(userRef, myUser);
        }
        finalizeLogin();
    };

    function finalizeLogin() {
        localStorage.setItem("chatUser", myUser.username);
        localStorage.setItem("chatPass", document.getElementById("logPass").value); // For auto-login in premium page
        
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("myAvatar").src = myUser.photo;
        
        if(myUser.isAdmin) document.getElementById("adminBtn").style.display = "block";
        
        loadMessages();
    }

    // --- Auto Login Check ---
    window.onload = () => {
        if(localStorage.getItem("chatUser")) {
            document.getElementById("logUser").value = localStorage.getItem("chatUser");
            if(localStorage.getItem("chatPass")) document.getElementById("logPass").value = localStorage.getItem("chatPass");
            // Auto click login if data exists
            // login(); // Uncomment for auto-login
        }
    }

    // --- Messaging ---
    window.sendMsg = async () => {
        const txt = document.getElementById("msg-input").value;
        if(!txt || !myUser) return;

        // Check Ban
        const banSnap = await get(child(ref(db, "bans"), myUser.uid));
        if(banSnap.exists()) return alert("â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");

        push(ref(db, "messages"), {
            text: txt,
            sender: myUser.displayName,
            photo: myUser.photo,
            uid: myUser.uid,
            username: myUser.username, // stored to link profile
            isPremium: myUser.isPremium || false,
            customID: myUser.customID || null,
            time: Date.now()
        });
        document.getElementById("msg-input").value = "";
    };

    function loadMessages() {
        onChildAdded(ref(db, "messages"), (snap) => {
            const d = snap.val();
            const div = document.createElement("div");
            const isMe = d.username === myUser.username;
            
            div.className = `msg-row ${isMe ? 'me' : 'other'}`;
            
            // Logic for Premium Display
            let bubbleClass = "msg-bubble";
            let idHTML = `<span class="id-tag">UID: ${d.uid}</span>`;
            let vipBadge = "";
            
            if(d.isPremium) {
                bubbleClass += " premium";
                vipBadge = `<span class="vip-badge">VIP</span>`;
                if(d.customID) {
                    idHTML = `<span class="id-tag">ID</span> <span class="vip-id-text">${d.customID}</span>`;
                }
            }

            div.innerHTML = `
                <img class="msg-avatar" src="${d.photo}" onclick="window.fetchUser('${d.username}')">
                <div class="${bubbleClass}">
                    <div style="font-size:10px; margin-bottom:4px; display:flex; align-items:center;">
                        ${vipBadge}
                        <b style="color:${d.isPremium ? '#00e5ff' : '#aaa'}">${d.sender}</b>
                        ${idHTML}
                    </div>
                    ${d.text}
                </div>
            `;
            const box = document.getElementById("chat-box");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });
    }

    // --- Profile & Admin Logic ---
    
    // Helper to fetch user data for profile modal
    window.fetchUser = async (username) => {
        const s = await get(child(ref(db, "users"), username));
        if(s.exists()) openProfile(s.val());
    };

    window.openProfile = (uData) => {
        const modal = document.getElementById("modal-overlay");
        const isMe = uData.username === myUser.username;

        document.getElementById("pImg").src = uData.photo;
        document.getElementById("pName").innerText = uData.displayName;
        document.getElementById("pBio").innerText = uData.bio || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©";
        
        let idDisplay = `UID: ${uData.uid}`;
        if(uData.isPremium && uData.customID) idDisplay = `<span style="color:#00e5ff">ğŸ’ ID: ${uData.customID}</span>`;
        document.getElementById("pIdBox").innerHTML = idDisplay;

        // Show Edit if me
        document.getElementById("editSelf").style.display = isMe ? "block" : "none";
        // Show Admin Panel only if I am admin AND I clicked admin button (or just hide it here)
        document.getElementById("adminPanel").style.display = "none"; 

        modal.style.display = "flex";
    };

    window.openAdmin = () => {
        document.getElementById("modal-overlay").style.display = "flex";
        document.getElementById("profileView").style.display = "none";
        document.getElementById("editSelf").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
    };

    window.closeModal = () => {
        document.getElementById("modal-overlay").style.display = "none";
        document.getElementById("profileView").style.display = "block"; // reset
        document.getElementById("searchRes").style.display = "none";
    };

    window.saveProfile = async () => {
        const bio = document.getElementById("editBio").value;
        const photo = document.getElementById("editPhoto").value;
        const updates = {};
        if(bio) updates.bio = bio;
        if(photo) updates.photo = photo;
        
        if(Object.keys(updates).length > 0) {
            await update(ref(db, "users/" + myUser.username), updates);
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«! (Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)");
            // Local update
            myUser = { ...myUser, ...updates };
            document.getElementById("myAvatar").src = myUser.photo;
        }
    };

    // --- Search & Ban (Admin) ---
    window.searchUser = async () => {
        const q = document.getElementById("searchInp").value.trim();
        if(!q) return;

        const usersSnap = await get(ref(db, "users"));
        let found = null;
        targetUserKey = null;

        usersSnap.forEach(s => {
            const u = s.val();
            // Search by real UID OR Custom ID
            if(u.uid == q || (u.isPremium && u.customID == q)) {
                found = u;
                targetUserKey = u.uid; // Ban by UID
            }
        });

        const resBox = document.getElementById("searchRes");
        resBox.style.display = "block";
        if(found) {
            document.getElementById("resName").innerText = found.displayName;
            document.getElementById("resUid").innerText = found.uid;
            document.getElementById("resStatus").innerText = found.isPremium ? "ğŸ’ Ù…Ù…ÙŠØ²" : "Ø¹Ø§Ø¯ÙŠ";
        } else {
            document.getElementById("resName").innerText = "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
            targetUserKey = null;
        }
    };

    window.banUser = async () => {
        if(!targetUserKey) return;
        await set(ref(db, "bans/" + targetUserKey), { time: Date.now() });
        alert("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ â›”");
    };

</script>
</body>
</html>

