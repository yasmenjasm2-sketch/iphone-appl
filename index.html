<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>Ø´Ø§Øª Ø¨Ù„Ø³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø§Ø³ÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-dark: #0a0a0a;
        --bg-panel: #141414;
        --accent-color: #00bcd4;
        --accent-glow: rgba(0, 188, 212, 0.4);
        --text-main: #ececec;
        --text-secondary: #aaaaaa;
        --msg-bg-me: #006064;
        --msg-bg-other: #1e1e1e;
        --instagram-grad: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
        background-color: var(--bg-dark);
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(30, 30, 30, 0.8) 0%, transparent 40%),
            radial-gradient(circle at 90% 80%, rgba(20, 20, 20, 0.8) 0%, transparent 40%);
        color: var(--text-main);
        font-family: 'Tajawal', sans-serif;
        margin: 0; padding: 0;
        /* Ø§Ø³ØªØ®Ø¯Ø§Ù… dvh ÙŠØ¶Ù…Ù† ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        height: 100dvh; 
        overflow: hidden;
        display: flex; justify-content: center; align-items: center;
    }

    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(30px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    #login-screen {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(15px);
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08);
        width: 90%; max-width: 380px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        animation: slideUpFade 0.6s ease-out;
        z-index: 100;
        display: flex; flex-direction: column; gap: 15px;
    }

    #login-screen h2 { margin: 0 0 10px 0; color: var(--accent-color); font-weight: 800; letter-spacing: 1px; }

    .login-input { 
        width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid #333;
        color: white; border-radius: 12px; font-size: 14px; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }
    
    .file-upload-wrapper {
        background: rgba(255,255,255,0.03); border: 1px dashed #444;
        border-radius: 12px; padding: 15px; cursor: pointer;
        transition: 0.3s; display: flex; flex-direction: column; align-items: center;
    }
    .file-upload-wrapper:hover { border-color: var(--accent-color); }
    #preview-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); margin-bottom: 5px; display: none; }

    .btn-main { 
        width: 100%; padding: 14px;
        background: linear-gradient(135deg, #0097a7, #006064);
        color: white; border: none; border-radius: 12px;
        font-weight: bold; cursor: pointer; font-size: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Ø²Ø± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ (Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…) */
    .btn-support {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 12px;
        background: var(--instagram-grad);
        color: white; border: none; border-radius: 12px;
        font-weight: bold; cursor: pointer; text-decoration: none; font-size: 14px;
        margin-top: 5px;
        transition: transform 0.2s;
    }
    .btn-support:active { transform: scale(0.96); }

    /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª --- */
    #chat-screen {
        display: none; 
        width: 100%; height: 100dvh; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        background: #000;
        flex-direction: column;
        animation: slideUpFade 0.5s ease;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .chat-header {
        height: 60px; flex-shrink: 0;
        background: rgba(20, 20, 20, 0.98);
        border-bottom: 1px solid #222;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px;
        z-index: 50;
    }
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    /* ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
    #myHeaderAvatar {
        width: 38px; height: 38px; border-radius: 50%;
        object-fit: cover; border: 2px solid var(--accent-color);
        cursor: pointer; transition: 0.3s;
    }
    #myHeaderAvatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--accent-glow); }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #chat-box {
        flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
        overflow-y: auto; 
        padding: 15px;
        background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://www.transparenttextures.com/patterns/dark-matter.png');
        scroll-behavior: smooth;
    }

    .msg-row { display: flex; margin-bottom: 12px; align-items: flex-end; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin: 0 8px; border: 1px solid #333; cursor: pointer; }
    
    .msg-content {
        max-width: 75%; padding: 8px 12px; border-radius: 16px; position: relative;
        font-size: 14px; line-height: 1.4; word-break: break-word;
    }
    .msg-row.other .msg-content { background: var(--msg-bg-other); border-bottom-left-radius: 4px; border: 1px solid #333; }
    .msg-row.me .msg-content { background: var(--msg-bg-me); color: white; border-bottom-right-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
    
    .msg-name { font-size: 10px; font-weight: bold; margin-bottom: 2px; display: block; color: var(--accent-color); }
    .msg-img-content { max-width: 100%; border-radius: 8px; margin-top: 5px; }

    /* Ø§Ù„ÙÙˆØªØ± (Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©) - ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ */
    .chat-footer {
        flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ‚Ù„Øµ */
        padding: 10px;
        background: #141414;
        border-top: 1px solid #222;
        display: flex; align-items: center; gap: 8px;
    }
    
    .input-container {
        flex: 1; background: #222; border-radius: 20px;
        display: flex; align-items: center; padding: 5px 12px;
        border: 1px solid #333;
    }
    #msg-input { flex: 1; background: transparent; border: none; color: white; padding: 8px; font-size: 14px; }
    .btn-send {
        background: var(--accent-color); color: white; width: 40px; height: 40px;
        border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) --- */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; backdrop-filter: blur(4px); }
    #profileModal {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #181818; border: 1px solid #444; width: 85%; max-width: 320px;
        padding: 25px; border-radius: 20px; z-index: 1001; display: none; text-align: center;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }

    .modal-img-large { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-color); margin-bottom: 10px; object-fit: cover; }
    .bio-text { color: #888; font-size: 13px; margin: 10px 0; font-style: italic; background: #111; padding: 5px; border-radius: 5px; min-height: 20px;}
    
    /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨) */
    .edit-tools { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; display: none; }
    .edit-input { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; margin-bottom: 5px; font-size: 12px; }
    .btn-save { background: #00695c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 12px; }

</style>
</head>
<body>

<div id="login-screen">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    
    <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)">
    <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input type="text" id="realName" class="login-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± (NickName)">
    
    <div class="file-upload-wrapper" onclick="document.getElementById('profilePicInput').click()">
        <img id="preview-avatar" src="">
        <span id="upload-text" style="color:#888; font-size:12px;">ğŸ“¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
        <input type="file" id="profilePicInput" hidden accept="image/*" onchange="handleProfilePicSelect(this)">
    </div>
    
    <button class="btn-main" onclick="attemptLogin()">ğŸš€ Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    
    <a href="https://www.instagram.com/6i99n?igsh=MW1wMTNpamJpMWNxeg==" target="_blank" class="btn-support">
        <svg fill="white" width="18" height="18" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ / Ø´ÙƒÙˆÙ‰
    </a>
</div>

<div id="chat-screen">
    <div class="chat-header">
        <div class="app-title" style="font-weight:bold; color:var(--accent-color);">Chat<span style="color:white">Plus</span></div>
        <div class="header-right">
            <img id="myHeaderAvatar" src="" onclick="openMyProfile()">
            <button onclick="logout()" style="background:none; border:none; color:#d32f2f; font-size:12px; cursor:pointer; font-weight:bold;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="chat-footer">
        <button class="btn-send" style="background:#333; width:35px; height:35px;" onclick="document.getElementById('msgImgInput').click()">ğŸ“·</button>
        <input type="file" id="msgImgInput" hidden accept="image/*">
        
        <div class="input-container">
            <input id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
        </div>
        
        <button class="btn-send" onclick="sendTextMsg()">â¤</button>
    </div>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="profileModal">
    <button onclick="closeModal()" style="position:absolute; top:10px; right:15px; background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">âœ•</button>
    
    <img id="pModalImg" class="modal-img-large" src="">
    <h3 id="pModalName" style="margin:5px 0; color:white;"></h3>
    <div style="font-size:12px; color:#555; margin-bottom:5px;" id="pModalUid"></div>
    
    <div id="pModalBio" class="bio-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</div>

    <div id="editProfileTools" class="edit-tools">
        <label style="display:block; color:#aaa; font-size:10px; text-align:right;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©:</label>
        <input type="text" id="editBioInput" class="edit-input" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ...">
        
        <label style="display:block; color:#aaa; font-size:10px; text-align:right; margin-top:5px;">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©:</label>
        <button onclick="document.getElementById('editPicInput').click()" style="width:100%; padding:5px; background:#333; color:#ccc; border:1px solid #555; border-radius:5px; margin-bottom:5px; font-size:11px;">ğŸ“‚ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <input type="file" id="editPicInput" hidden accept="image/*" onchange="previewEditPic(this)">
        
        <button class="btn-save" onclick="saveProfileChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>

    <div id="adminPanel" class="edit-tools" style="border-color:#d32f2f;">
        <h4 style="color:#d32f2f; margin:0 0 5px 0; font-size:12px;">ğŸš« Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h4>
        <input type="number" id="banDuration" class="edit-input" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø­Ø¸Ø± (Ø³Ø§Ø¹Ø§Øª)">
        <button class="btn-save" style="background:#d32f2f;" onclick="executeBan()">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, onChildAdded, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdbUK04WTiBvv3z1K9oYhssfpJTI9fZh4",
    authDomain: "chatdoy.firebaseapp.com",
    databaseURL: "https://chatdoy-default-rtdb.firebaseio.com",
    projectId: "chatdoy",
    storageBucket: "chatdoy.firebasestorage.app",
    messagingSenderId: "922018470576",
    appId: "1:922018470576:web:bbe06151c06e345c4cb975",
    measurementId: "G-6V7VB06ZPL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "messages");
  const bansRef = ref(db, "bans");
  const usersRef = ref(db, "users");

  let myUser = { username: "", displayName: "", photo: "", uid: "", bio: "", isAdmin: false };
  let tempProfilePicBase64 = ""; 
  let tempEditPicBase64 = ""; // Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
  let selectedUserProfile = null; // Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹

  // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ---
  window.onload = () => {
      const savedUser = localStorage.getItem("chat_username");
      const savedPass = localStorage.getItem("chat_password");
      if(savedUser && savedPass) {
          document.getElementById("username").value = savedUser;
          document.getElementById("password").value = savedPass;
          attemptLogin();
      }
  };

  // ÙˆØ¸ÙŠÙØ© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
  function compressImage(file, maxWidth, quality, callback) {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = event => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
              const canvas = document.createElement('canvas');
              const ratio = maxWidth / img.width;
              canvas.width = maxWidth;
              canvas.height = img.height * ratio;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              callback(canvas.toDataURL('image/jpeg', quality));
          };
      };
  }

  window.handleProfilePicSelect = (input) => {
      if (input.files[0]) {
          compressImage(input.files[0], 150, 0.7, (base64) => {
              tempProfilePicBase64 = base64;
              document.getElementById('preview-avatar').src = base64;
              document.getElementById('preview-avatar').style.display = 'block';
              document.getElementById('upload-text').style.display = 'none';
          });
      }
  };

  // --- Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
  window.attemptLogin = async () => {
      const uUser = document.getElementById("username").value.trim().toLowerCase(); // ØªØ­ÙˆÙŠÙ„ Ù„Ø­Ø±ÙˆÙ ØµØºÙŠØ±Ø©
      const uPass = document.getElementById("password").value.trim();
      const uRealName = document.getElementById("realName").value.trim();

      if(!uUser || !uPass) { alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }
      if(uUser.length < 2) { alert("â›” ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

      // Ø§Ù„Ø£Ø¯Ù…Ù†
      if (uUser === "texn" && uPass === "hamzagmail34567") {
          startChat("texn", "ğ‘ğ„ğŒğ€ğ’ à¼—", "https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg", "1111", "Admin", true);
          return;
      }

      const userNode = child(usersRef, uUser);
      const snap = await get(userNode);
      const defaultPic = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

      if (snap.exists()) {
          const data = snap.val();
          if (data.password === uPass) {
              // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              const finalName = uRealName || data.displayName;
              const finalPhoto = tempProfilePicBase64 || data.photo || defaultPic;
              
              if(uRealName || tempProfilePicBase64) {
                  update(userNode, { displayName: finalName, photo: finalPhoto });
              }
              startChat(uUser, finalName, finalPhoto, data.uid, data.bio || "", false);
          } else { alert("â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©"); }
      } else {
          // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
          if(!uRealName) { alert("ğŸ“ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¸Ø§Ù‡Ø±"); return; }
          const newUid = Math.floor(1000000000 + Math.random() * 9000000000).toString();
          const finalPhoto = tempProfilePicBase64 || defaultPic;

          await set(userNode, { 
              password: uPass, 
              uid: newUid, 
              displayName: uRealName, 
              photo: finalPhoto,
              bio: "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø´Ø§Øª Ø¨Ù„Ø³"
          });
          startChat(uUser, uRealName, finalPhoto, newUid, "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", false);
      }
  };

  function startChat(username, realName, photo, uid, bio, isAdmin) {
      // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±
      myUser = { username, displayName: realName, photo, uid, bio, isAdmin };
      
      // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ LocalStorage
      localStorage.setItem("chat_username", username);
      localStorage.setItem("chat_password", document.getElementById("password").value);

      // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("chat-screen").style.display = "flex";
      
      // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
      document.getElementById("myHeaderAvatar").src = photo;

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
      // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… onChildAdded ÙˆÙ‡Ùˆ Ø³ÙŠØ¬Ù„Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯
      // Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù€ reload Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙØ±Øº Ø§Ù„Ù€ DOM Ù„Ø°Ø§ Ù„Ø§ Ù…Ø´ÙƒÙ„Ø©
      onChildAdded(chatRef, renderMessage);
  }

  window.logout = () => {
      localStorage.removeItem("chat_username");
      localStorage.removeItem("chat_password");
      location.reload();
  }

  // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
  window.sendTextMsg = async () => {
      const input = document.getElementById("msg-input");
      if(input.value.trim()) {
          await sendMessage(input.value.trim(), null);
          input.value = "";
          input.focus();
      }
  };

  document.getElementById("msg-input").addEventListener("keydown", (e) => {
      if(e.key === "Enter") window.sendTextMsg();
  });

  document.getElementById("msgImgInput").addEventListener("change", function() {
      if(this.files[0]) {
          compressImage(this.files[0], 400, 0.7, async (base64) => {
             await sendMessage(null, base64);
          });
      }
      this.value = "";
  });

  async function sendMessage(text, imgBase64) {
      const banCheck = await get(child(bansRef, myUser.uid));
      if (banCheck.exists()) {
          if (banCheck.val().until > Date.now()) { alert("â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ±"); return; }
      }

      push(chatRef, {
        senderName: myUser.displayName,
        senderPhoto: myUser.photo,
        uid: myUser.uid,
        isAdmin: myUser.isAdmin,
        text: text,
        image: imgBase64,
        type: "msg",
        time: Date.now()
      });
  }

  function renderMessage(snap) {
      const d = snap.val();
      const chatBox = document.getElementById("chat-box");
      const div = document.createElement("div");
      
      if (d.type === "system") {
          div.style.textAlign = "center"; div.style.margin = "10px 0";
          div.innerHTML = `<span style="background:rgba(200,0,0,0.3); color:#ffcccb; padding:4px 8px; border-radius:5px; font-size:11px;">ğŸ”” ${d.text}</span>`;
      } else {
          const isMe = d.uid === myUser.uid;
          div.className = `msg-row ${isMe ? 'me' : 'other'}`;
          
          const time = new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          const nameColor = d.isAdmin ? '#ff4444' : 'var(--accent-color)';
          const nameText = d.isAdmin ? `ğŸ‘‘ ${d.senderName}` : d.senderName;
          
          let content = "";
          if(d.text) content += `<div>${d.text}</div>`;
          if(d.image) content += `<img src="${d.image}" class="msg-img-content" onclick="window.open(this.src)">`;

          div.innerHTML = `
            <img class="msg-avatar" src="${d.senderPhoto}" onclick="showProfile('${d.senderName}', '${d.senderPhoto}', '${d.uid}')">
            <div class="msg-content">
                <span class="msg-name" style="color:${nameColor}">${nameText}</span>
                ${content}
                <div style="font-size:9px; opacity:0.6; text-align:left; margin-top:4px;">${time}</div>
            </div>
          `;
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

  // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø·ÙˆØ± ---
  window.openMyProfile = async () => {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„ØªØ£ÙƒØ¯
      const snap = await get(child(usersRef, myUser.username));
      let currentBio = myUser.bio;
      let currentPhoto = myUser.photo;
      
      if(snap.exists()) {
          currentBio = snap.val().bio || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©";
          currentPhoto = snap.val().photo;
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ
          myUser.bio = currentBio;
          myUser.photo = currentPhoto;
      }
      
      showProfile(myUser.displayName, currentPhoto, myUser.uid, currentBio, true);
  };

  // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨Ø§ÙŠÙˆ ÙˆØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ù‡Ùˆ Ø­Ø³Ø§Ø¨ÙŠ Ø£Ù… Ù„Ø§
  window.showProfile = async (name, photo, uid, bioParam = null, isMe = false) => {
      selectedUserProfile = { name, uid, photo }; // ØªØ®Ø²ÙŠÙ† Ù…Ø¨Ø¯Ø¦ÙŠ
      
      document.getElementById("pModalName").innerText = name;
      document.getElementById("pModalImg").src = photo;
      document.getElementById("pModalUid").innerText = "ID: " + uid;
      
      // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§ÙŠÙˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ù…Ø±Ø± (Ø£ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø´Ø®Øµ Ø¢Ø®Ø±)
      let bioText = bioParam;
      if(!bioText) {
           // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù€ UID (Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¨Ø·ÙŠØ¦Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù…Ù‚Ø¨ÙˆÙ„Ø©)
           // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ… Ù„Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø± Ù‡Ù†Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ø³Ù†Ø¹Ø±Ø¶ "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."
           document.getElementById("pModalBio").innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...";
           
           // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Realtime ÙŠÙØ¶Ù„ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ UID ÙƒÙ€ Key Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
           // ÙˆÙ„ÙƒÙ† Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù€ Key Ù‡Ùˆ usernameØŒ Ø³Ù†ÙƒØªÙÙŠ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§ÙŠÙˆ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±ÙÙ‡ØŒ Ø£Ùˆ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªØ¨Ø³ÙŠØ·
           // Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹: Ø¹Ø±Ø¶ "Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Øª Ø¨Ù„Ø³" Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†
           bioText = "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…ÙŠØ² ÙÙŠ Ø´Ø§Øª Ø¨Ù„Ø³"; 
      }
      document.getElementById("pModalBio").innerText = bioText;

      // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ
      // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ UID ÙŠØ·Ø§Ø¨Ù‚ Ø®Ø§ØµØªÙŠ
      const amITheOwner = (uid === myUser.uid);
      
      if(amITheOwner) {
          document.getElementById("editProfileTools").style.display = "block";
          document.getElementById("editBioInput").value = myUser.bio || "";
          document.getElementById("adminPanel").style.display = "none";
      } else {
          document.getElementById("editProfileTools").style.display = "none";
          // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
          if(myUser.isAdmin && uid !== "1111") {
              document.getElementById("adminPanel").style.display = "block";
          } else {
              document.getElementById("adminPanel").style.display = "none";
          }
      }

      document.getElementById("overlay").style.display = "block";
      document.getElementById("profileModal").style.display = "block";
  };

  window.previewEditPic = (input) => {
      if(input.files[0]) {
          compressImage(input.files[0], 150, 0.7, (base64) => {
              tempEditPicBase64 = base64;
              document.getElementById("pModalImg").src = base64; // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©
          });
      }
  };

  window.saveProfileChanges = async () => {
      const newBio = document.getElementById("editBioInput").value.trim();
      const updates = {};
      
      if(newBio) {
          updates.bio = newBio;
          myUser.bio = newBio;
          document.getElementById("pModalBio").innerText = newBio;
      }
      
      if(tempEditPicBase64) {
          updates.photo = tempEditPicBase64;
          myUser.photo = tempEditPicBase64;
          document.getElementById("myHeaderAvatar").src = tempEditPicBase64; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
      }
      
      if(Object.keys(updates).length > 0) {
          await update(child(usersRef, myUser.username), updates);
          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª");
          closeModal();
      }
  };

  window.closeModal = () => {
      document.getElementById("profileModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
      tempEditPicBase64 = ""; // ØªØµÙÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
  };

  window.executeBan = () => {
      const hours = document.getElementById("banDuration").value;
      if(!hours) return;
      const liftTime = Date.now() + (hours * 60 * 60 * 1000);
      
      push(chatRef, { text: `â›” ØªÙ… Ø­Ø¸Ø± ${selectedUserProfile.name} Ù„Ù…Ø¯Ø© ${hours} Ø³Ø§Ø¹Ø©`, type: "system", uid: "0000" });
      set(child(bansRef, selectedUserProfile.uid), { until: liftTime });
      closeModal();
  };

</script>
</body>
</html>
