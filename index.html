<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª Ù…Ø·ÙˆØ± - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</title>
<style>
    body { background:#050505; color:white; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    
    /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    #login-screen {
        background: #111; padding: 40px; border-radius: 10px; border: 1px solid #333;
        width: 300px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    #login-screen h2 { color: #4fc3f7; margin-bottom: 20px; }
    .login-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
    .btn-login { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
    .btn-login:hover { background: #00897b; }

    /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª (Ù…Ø®ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) --- */
    #chat-screen { display: none; width: 90%; max-width: 600px; margin: 20px auto; flex-direction: column; height: 90vh; }
    
    .header-controls { display: flex; gap: 10px; margin-bottom: 10px; }
    #searchId { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #1a1a1a; color: #fff; }
    
    #chat-box { flex: 1; overflow-y:auto; border:1px solid #333; padding:15px; margin-bottom:10px; background: #0a0a0a; border-radius: 8px; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .msg { margin: 10px 0; padding: 10px; border-bottom: 1px solid #1a1a1a; border-radius: 5px; background: #111; }
    .msg-header { font-size: 0.75em; color: #666; display: flex; justify-content: space-between; margin-bottom: 5px; }
    
    .name { font-weight:bold; cursor: pointer; text-decoration: none; padding: 2px 5px; border-radius: 3px; }
    .name:hover { background: #333; }
    .name.user { color:#4fc3f7; }
    
    /* --- Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø®Ø§Øµ --- */
    .name.admin { color: #ff1744; text-shadow: 0 0 5px #ff1744; }
    
    /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…ØªØ¯Ø±Ø¬Ø© */
    .msg.admin-msg {
        border: 1px solid #444;
    }
    .msg.admin-msg .text-content {
        font-weight: bold;
        font-size: 1.1em;
        /* Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚ ÙˆØ£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
        background: linear-gradient(45deg, #8B0000, #00008B, #8B0000);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientText 3s ease infinite;
    }
    @keyframes gradientText {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
    .sys-msg { background: #330d0d; border: 1px solid #b71c1c; color: #ef9a9a; text-align: center; font-size: 0.9em; }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    .input-area { display: flex; gap: 10px; }
    #msg-input { flex: 1; padding:12px; border-radius:4px; border:none; background: #222; color: white; }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø¸Ø± */
    #banModal {
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #1e1e1e; border: 1px solid #555; padding: 20px; z-index: 1000;
        width: 300px; text-align: center; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,1);
    }
    #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
</style>
</head>
<body>

<div id="login-screen">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)">
    <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Password)">
    <button class="btn-login" onclick="login()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    <p style="font-size:12px; color:#666; margin-top:15px;">Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
</div>

<div id="chat-screen">
    <div class="header-controls">
        <input id="searchId" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± ID...">
        <button onclick="location.reload()" style="background:#333; border:none; color:white; padding:0 15px; border-radius:4px; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <input id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶ØºØ· Enter...">
    </div>
    <div style="font-size: 11px; color: #555; margin-top: 5px; text-align: center;">Chat System v2.0 - Secure ID</div>
</div>

<div id="overlay"></div>
<div id="banModal">
    <h3 style="color:#ff1744; margin-top:0;">â›” Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <p id="banTargetName" style="color:#ccc;"></p>
    <input type="number" id="banDuration" placeholder="Ø§Ù„Ù…Ø¯Ø©" style="padding:8px; width:60px; background:#333; border:none; color:white;">
    <select id="banUnit" style="padding: 8px; background: #333; color: white; border: none;">
        <option value="hours">Ø³Ø§Ø¹Ø§Øª</option>
        <option value="seconds">Ø«ÙˆØ§Ù†ÙŠ</option>
    </select>
    <br><br>
    <button onclick="confirmBan()" style="background:#d32f2f; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Ø­Ø¸Ø±</button>
    <button onclick="closeModal()" style="background:#555; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdbUK04WTiBvv3z1K9oYhssfpJTI9fZh4",
    authDomain: "chatdoy.firebaseapp.com",
    databaseURL: "https://chatdoy-default-rtdb.firebaseio.com",
    projectId: "chatdoy",
    storageBucket: "chatdoy.firebasestorage.app",
    messagingSenderId: "922018470576",
    appId: "1:922018470576:web:bbe06151c06e345c4cb975",
    measurementId: "G-6V7VB06ZPL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "messages");
  const bansRef = ref(db, "bans");
  const usersRef = ref(db, "users");

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  let currentUser = {
      name: "",
      uid: "",
      isAdmin: false
  };
  let targetBanUser = null;

  // Ø±Ø¨Ø· Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ onclick ÙÙŠ HTML)
  window.login = loginFunc;
  window.openAdminMenu = openAdminMenuFunc;
  window.closeModal = () => {
      document.getElementById("banModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
  };
  window.confirmBan = confirmBanFunc;

  // --- Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
  async function loginFunc() {
      const userIn = document.getElementById("username").value.trim();
      const passIn = document.getElementById("password").value.trim();

      if(!userIn || !passIn) { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø®Ø§Øµ
      if (userIn === "texn") {
          if (passIn === "hamzagmail34567") {
              startApp("ğ‘ğ„ğŒğ€ğ’ à¼—", "1111", true); // Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø«Ø§Ø¨Øª
          } else {
              alert("âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù† ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
          }
          return;
      }

      // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
      const userNode = child(usersRef, userIn);
      
      try {
          const snapshot = await get(userNode);
          
          if (snapshot.exists()) {
              // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
              const userData = snapshot.val();
              if (userData.password === passIn) {
                  startApp(userIn, userData.uid, false);
              } else {
                  alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!");
              }
          } else {
              // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
              const newUid = Math.floor(1000000000 + Math.random() * 9000000000).toString();
              await set(userNode, {
                  password: passIn,
                  uid: newUid
              });
              alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
              startApp(userIn, newUid, false);
          }
      } catch (error) {
          console.error(error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
      }
  }

  // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
  function startApp(name, uid, isAdmin) {
      currentUser.name = name;
      currentUser.uid = uid;
      currentUser.isAdmin = isAdmin;

      // Ø¥Ø®ÙØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("chat-screen").style.display = "flex";
      
      // ØªØºÙŠÙŠØ± ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø³Ù… Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Øª
      document.body.style.display = "block"; 
      
      // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      onChildAdded(chatRef, renderMessage);
  }

  // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
  document.getElementById("msg-input").addEventListener("keydown", async (e) => {
    if(e.key === "Enter" && e.target.value.trim()){
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
      const banCheck = await get(child(bansRef, currentUser.uid));
      if (banCheck.exists()) {
          const banData = banCheck.val();
          if (banData.until > Date.now()) {
              const remaining = Math.ceil((banData.until - Date.now())/1000);
              alert(`â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ±! Ø¨Ø§Ù‚ÙŠ: ${remaining} Ø«Ø§Ù†ÙŠØ©`);
              return;
          }
      }

      push(chatRef, {
        name: currentUser.name,
        text: e.target.value,
        uid: currentUser.uid,
        isAdmin: currentUser.isAdmin,
        type: "msg",
        time: Date.now()
      });
      e.target.value = "";
    }
  });

  // --- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
  function renderMessage(snap) {
    const d = snap.val();
    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");
    
    div.dataset.uid = d.uid; // Ù„Ù„Ø¨Ø­Ø«

    if (d.type === "system") {
        div.className = "msg sys-msg";
        div.innerHTML = `âš ï¸ ${d.text}`;
    } else {
        const isAdminMsg = d.isAdmin;
        div.className = `msg ${isAdminMsg ? "admin-msg" : ""}`;
        
        const timeStr = new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const nameClass = isAdminMsg ? "name admin" : "name user";
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø¯Ù…Ù† Ù†Ø¹Ø±Ø¶ ğ‘ğ„ğŒğ€ğ’ à¼— ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
        const displayName = d.name;

        div.innerHTML = `
            <div class="msg-header">
                <span style="font-family:monospace">ID: ${d.uid}</span>
                <span>${timeStr}</span>
            </div>
            <div>
                <span class="${nameClass}" onclick="openAdminMenu('${displayName}', '${d.uid}', ${isAdminMsg})">${displayName}</span>: 
                <span class="text-content">${d.text}</span>
            </div>
        `;
    }

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    filterMessages(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„ØªØ±
  }

  // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---
  function openAdminMenuFunc(name, uid, isTargetAdmin) {
      if (!currentUser.isAdmin) return;
      if (isTargetAdmin || uid === "1111") {
          alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¸Ø± Ø§Ù„Ø£Ø¯Ù…Ù†!");
          return;
      }

      targetBanUser = { name: name, id: uid };
      document.getElementById("banTargetName").innerText = `${name} (ID: ${uid})`;
      document.getElementById("banModal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
  }

  function confirmBanFunc() {
      const duration = document.getElementById("banDuration").value;
      const unit = document.getElementById("banUnit").value;
      
      if (!duration || !targetBanUser) return;

      let multiplier = 1000;
      if (unit === "hours") multiplier = 1000 * 60 * 60;
      
      const liftTime = Date.now() + (duration * multiplier);

      // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø§Øª
      push(chatRef, {
          name: "System",
          text: `ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${targetBanUser.name} Ù„Ø£Ù†Ù‡ Ù…Ø³ÙŠØ¡.`,
          uid: "0000",
          isAdmin: true,
          type: "system",
          time: Date.now()
      });

      // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
      set(child(bansRef, targetBanUser.id), {
          until: liftTime,
          reason: "Abusive"
      });

      window.closeModal();
  }

  // --- Ø§Ù„Ø¨Ø­Ø« ---
  document.getElementById("searchId").addEventListener("input", filterMessages);
  function filterMessages() {
      const query = document.getElementById("searchId").value.trim();
      const msgs = document.querySelectorAll("#chat-box .msg");
      msgs.forEach(m => {
          if(!query) {
              m.style.display = "block";
          } else {
              if(m.dataset.uid && m.dataset.uid.includes(query)) m.style.display = "block";
              else m.style.display = "none";
          }
      });
  }
</script>

</body>
</html>
