<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>Ø´Ø§Øª Ø¨Ù„Ø³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø§Ø³ÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-dark: #0a0a0a;
        --bg-panel: #141414;
        --accent-color: #00bcd4;
        --accent-glow: rgba(0, 188, 212, 0.4);
        --accent-gold: #ffd700;
        --text-main: #ececec;
        --text-secondary: #aaaaaa;
        --msg-bg-me: #006064;
        --msg-bg-other: #1e1e1e;
        --instagram-grad: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        --premium-grad: linear-gradient(135deg, #ffd700, #ffed4e);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
        background-color: var(--bg-dark);
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(30, 30, 30, 0.8) 0%, transparent 40%),
            radial-gradient(circle at 90% 80%, rgba(20, 20, 20, 0.8) 0%, transparent 40%);
        color: var(--text-main);
        font-family: 'Tajawal', sans-serif;
        margin: 0; padding: 0;
        height: 100dvh; overflow: hidden;
        display: flex; justify-content: center; align-items: center;
    }

    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(30px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes rainbow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    #login-screen {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(15px);
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08);
        width: 90%; max-width: 380px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        animation: slideUpFade 0.6s ease-out;
        z-index: 100;
        display: flex; flex-direction: column; gap: 15px;
        position: relative;
    }

    /* Ø²Ø± Ø§Ù„Ù€ Premium ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .premium-badge {
        position: absolute; top: -15px; right: 50%; transform: translateX(50%);
        background: var(--premium-grad); color: #000; padding: 8px 20px;
        border-radius: 25px; font-weight: 800; font-size: 12px;
        box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5); animation: glowPulse 2s infinite;
    }

    #login-screen h2 { margin: 0 0 10px 0; color: var(--accent-color); font-weight: 800; letter-spacing: 1px; }

    .login-input { 
        width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid #333;
        color: white; border-radius: 12px; font-size: 14px; transition: 0.3s;
    }
    .login-input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }
    
    .file-upload-wrapper {
        background: rgba(255,255,255,0.03); border: 1px dashed #444;
        border-radius: 12px; padding: 15px; cursor: pointer;
        transition: 0.3s; display: flex; flex-direction: column; align-items: center;
    }
    .file-upload-wrapper:hover { border-color: var(--accent-color); }
    #preview-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); margin-bottom: 5px; display: none; }

    .btn-main { 
        width: 100%; padding: 14px;
        background: linear-gradient(135deg, #0097a7, #006064);
        color: white; border: none; border-radius: 12px;
        font-weight: bold; cursor: pointer; font-size: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .btn-premium-login {
        background: var(--premium-grad) !important; color: #000 !important;
        box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4) !important;
        animation: glowPulse 2s infinite;
    }

    /* Ø²Ø± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ (Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…) */
    .btn-support {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 12px;
        background: var(--instagram-grad);
        color: white; border: none; border-radius: 12px;
        font-weight: bold; cursor: pointer; text-decoration: none; font-size: 14px;
        margin-top: 5px;
        transition: transform 0.2s;
    }
    .btn-support:active { transform: scale(0.96); }

    /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª --- */
    #chat-screen {
        display: none; 
        width: 100%; height: 100dvh;
        background: #000;
        flex-direction: column;
        animation: slideUpFade 0.5s ease;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
    .chat-header {
        height: 60px; flex-shrink: 0;
        background: rgba(20, 20, 20, 0.98);
        border-bottom: 1px solid #222;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px;
        z-index: 50; position: relative;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .premium-header-bar {
        position: absolute; top: 0; left: 0; right: 0;
        height: 4px; background: var(--premium-grad);
        display: none; animation: gradientShift 3s ease infinite;
    }

    .header-right { display: flex; align-items: center; gap: 10px; }
    
    #myHeaderAvatar {
        width: 38px; height: 38px; border-radius: 50%;
        object-fit: cover; border: 2px solid var(--accent-color);
        cursor: pointer; transition: 0.3s;
    }
    #myHeaderAvatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--accent-glow); }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #chat-box {
        flex: 1; overflow-y: auto; 
        padding: 15px;
        background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://www.transparenttextures.com/patterns/dark-matter.png');
        scroll-behavior: smooth;
    }

    .msg-row { display: flex; margin-bottom: 12px; align-items: flex-end; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin: 0 8px; border: 1px solid #333; cursor: pointer; }
    
    .msg-content {
        max-width: 75%; padding: 8px 12px; border-radius: 16px; position: relative;
        font-size: 14px; line-height: 1.4; word-break: break-word;
    }
    .msg-row.other .msg-content { background: var(--msg-bg-other); border-bottom-left-radius: 4px; border: 1px solid #333; }
    .msg-row.me .msg-content { background: var(--msg-bg-me); color: white; border-bottom-right-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
    
    /* Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ² */
    .premium-msg { border: 2px solid var(--accent-gold) !important; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
    .premium-msg .msg-content { 
        background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,237,78,0.15)) !important;
        animation: gradientShift 3s ease infinite;
    }

    .msg-name { font-size: 10px; font-weight: bold; margin-bottom: 2px; display: block; }
    .premium-id { 
        background: var(--premium-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        font-family: monospace !important; letter-spacing: 1px;
    }
    .msg-img-content { max-width: 100%; border-radius: 8px; margin-top: 5px; }

    /* Ø§Ù„ÙÙˆØªØ± */
    .chat-footer {
        flex-shrink: 0; padding: 10px;
        background: #141414;
        border-top: 1px solid #222;
        display: flex; align-items: center; gap: 8px;
    }
    
    .input-container {
        flex: 1; background: #222; border-radius: 20px;
        display: flex; align-items: center; padding: 5px 12px;
        border: 1px solid #333;
    }
    #msg-input { flex: 1; background: transparent; border: none; color: white; padding: 8px; font-size: 14px; }
    .btn-send {
        background: var(--accent-color); color: white; width: 40px; height: 40px;
        border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; backdrop-filter: blur(4px); }
    #profileModal {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #181818; border: 1px solid #444; width: 85%; max-width: 320px;
        padding: 25px; border-radius: 20px; z-index: 1001; display: none; text-align: center;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }

    .modal-img-large { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-color); margin-bottom: 10px; object-fit: cover; }
    .bio-text { color: #888; font-size: 13px; margin: 10px 0; font-style: italic; background: #111; padding: 5px; border-radius: 5px; min-height: 20px;}
    
    .edit-tools { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; display: none; }
    .edit-input { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; margin-bottom: 5px; font-size: 12px; }
    .btn-save { background: #00695c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 12px; }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±Ø© */
    #adminPanel { border-color: #d32f2f !important; }
    .admin-section { margin-bottom: 10px; }
    .admin-ip-input { width: 100%; padding: 6px; background: #1a0000; border: 1px solid #ff4444; color: #ff6666; border-radius: 4px; font-size: 11px; }

    @keyframes glowPulse {
        0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
        50% { box-shadow: 0 0 20px rgba(255,215,0,0.8); }
    }
</style>
</head>
<body>

<div id="login-screen">
    <div class="premium-badge" onclick="window.location.href='premium.html'">
        ğŸ‘‘ Ø´Ø±Ø§Ø¡ Ù…Ù…ÙŠØ²
    </div>
    
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    
    <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input type="text" id="realName" class="login-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±">
    
    <div class="file-upload-wrapper" onclick="document.getElementById('profilePicInput').click()">
        <img id="preview-avatar" src="">
        <span id="upload-text" style="color:#888; font-size:12px;">ğŸ“¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
        <input type="file" id="profilePicInput" hidden accept="image/*" onchange="handleProfilePicSelect(this)">
    </div>
    
    <button class="btn-main" onclick="attemptLogin()">ğŸš€ Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    
    <a href="https://www.instagram.com/6i99n?igsh=MW1wMTNpamJpMWNxeg==" target="_blank" class="btn-support">
        ğŸ“± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ / Ø´ÙƒÙˆÙ‰
    </a>
</div>

<div id="chat-screen">
    <div class="premium-header-bar" id="premiumHeaderBar"></div>
    
    <div class="chat-header">
        <div class="app-title" style="font-weight:bold; color:var(--accent-color);">Chat<span style="color:white">Plus</span></div>
        <div class="header-right">
            <img id="myHeaderAvatar" src="" onclick="openMyProfile()">
            <button class="btn-main btn-premium-login" onclick="window.location.href='premium.html'" id="premiumBtn" style="display:none; padding:8px 12px; font-size:12px; width:auto;">
                ğŸ‘‘ Ù…Ù…ÙŠØ²
            </button>
            <button onclick="logout()" style="background:none; border:none; color:#d32f2f; font-size:12px; cursor:pointer; font-weight:bold;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="chat-footer">
        <button class="btn-send" style="background:#333; width:35px; height:35px;" onclick="document.getElementById('msgImgInput').click()">ğŸ“·</button>
        <input type="file" id="msgImgInput" hidden accept="image/*">
        
        <div class="input-container">
            <input id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
        </div>
        
        <button class="btn-send" onclick="sendTextMsg()">â¤</button>
    </div>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="profileModal">
    <button onclick="closeModal()" style="position:absolute; top:10px; right:15px; background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">âœ•</button>
    
    <img id="pModalImg" class="modal-img-large" src="">
    <h3 id="pModalName" style="margin:5px 0; color:white;"></h3>
    <div style="font-size:12px; color:#555; margin-bottom:5px;" id="pModalUid"></div>
    
    <div id="pModalBio" class="bio-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</div>

    <div id="editProfileTools" class="edit-tools">
        <input type="text" id="editBioInput" class="edit-input" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ...">
        <button onclick="document.getElementById('editPicInput').click()" style="width:100%; padding:5px; background:#333; color:#ccc; border:1px solid #555; border-radius:5px; margin:5px 0; font-size:11px;">ğŸ“‚ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <input type="file" id="editPicInput" hidden accept="image/*" onchange="previewEditPic(this)">
        <button class="btn-save" onclick="saveProfileChanges()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>

    <div id="adminPanel" class="edit-tools">
        <h4 style="color:#d32f2f; margin:0 0 10px 0; font-size:12px;">ğŸš« Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h4>
        
        <div class="admin-section">
            <input type="number" id="banDuration" class="edit-input" placeholder="Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø¸Ø±">
            <button class="btn-save" style="background:#d32f2f; font-size:11px; padding:6px;" onclick="executeBan()">Ø­Ø¸Ø±</button>
        </div>
        
        <div class="admin-section">
            <input type="text" id="banIpInput" class="admin-ip-input" placeholder="Ø­Ø¸Ø± IP">
            <button class="btn-save" style="background:#d32f2f; font-size:11px; padding:6px;" onclick="banIP()">Ø­Ø¸Ø± IP</button>
        </div>
        
        <div class="admin-section">
            <input type="text" id="disableUserInput" class="edit-input" placeholder="ØªØ¹Ø·ÙŠÙ„ Ø­Ø³Ø§Ø¨ (username)">
            <button class="btn-save" style="background:#ff9800; font-size:11px; padding:6px;" onclick="disableAccount()">ØªØ¹Ø·ÙŠÙ„</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, set, get, child, onChildAdded, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDdbUK04WTiBvv3z1K9oYhssfpJTI9fZh4",
    authDomain: "chatdoy.firebaseapp.com",
    databaseURL: "https://chatdoy-default-rtdb.firebaseio.com",
    projectId: "chatdoy",
    storageBucket: "chatdoy.firebasestorage.app",
    messagingSenderId: "922018470576",
    appId: "1:922018470576:web:bbe06151c06e345c4cb975"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "messages");
const bansRef = ref(db, "bans");
const ipBansRef = ref(db, "ipBans");
const usersRef = ref(db, "users");

let myUser = { username: "", displayName: "", photo: "", uid: "", bio: "", isAdmin: false, premium: false, customId: "", color1: "", color2: "" };
let tempProfilePicBase64 = ""; 
let tempEditPicBase64 = "";
let selectedUserProfile = null;

window.onload = () => {
    const savedUser = localStorage.getItem("chat_username");
    const savedPass = localStorage.getItem("chat_password");
    if(savedUser && savedPass) {
        document.getElementById("username").value = savedUser;
        document.getElementById("password").value = savedPass;
        attemptLogin();
    }
};

function compressImage(file, maxWidth, quality, callback) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = event => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ratio = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * ratio;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            callback(canvas.toDataURL('image/jpeg', quality));
        };
    };
}

window.handleProfilePicSelect = (input) => {
    if (input.files[0]) {
        compressImage(input.files[0], 150, 0.7, (base64) => {
            tempProfilePicBase64 = base64;
            document.getElementById('preview-avatar').src = base64;
            document.getElementById('preview-avatar').style.display = 'block';
            document.getElementById('upload-text').style.display = 'none';
        });
    }
};

window.attemptLogin = async () => {
    const uUser = document.getElementById("username").value.trim().toLowerCase();
    const uPass = document.getElementById("password").value.trim();
    const uRealName = document.getElementById("realName").value.trim();

    if(!uUser || !uPass) { alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }
    if(uUser.length < 2) { alert("â›” Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹"); return; }

    // Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø®Ø§Øµ
    if (uUser === "texn" && uPass === "hamzagmail34567") {
        startChat("texn", "ğ‘ğ„ğŒğ€ğ’ à¼—", "https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg", "1111", "Admin", true);
        return;
    }

    const userNode = child(usersRef, uUser);
    const snap = await get(userNode);
    const defaultPic = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    if (snap.exists()) {
        const data = snap.val();
        if (data.password === uPass || data.disabled) {
            if (data.disabled) {
                alert("â›” Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†");
                return;
            }
            const finalName = uRealName || data.displayName;
            const finalPhoto = tempProfilePicBase64 || data.photo || defaultPic;
            
            if(uRealName || tempProfilePicBase64) {
                update(userNode, { displayName: finalName, photo: finalPhoto });
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²
            myUser.premium = data.premium || false;
            myUser.customId = data.customId || "";
            myUser.color1 = data.color1 || "";
            myUser.color2 = data.color2 || "";
            
            startChat(uUser, finalName, finalPhoto, data.uid, data.bio || "", data.isAdmin || false);
        } else { 
            alert("â›” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©"); 
        }
    } else {
        if(!uRealName) { alert("ğŸ“ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ"); return; }
        const newUid = Math.floor(1000000000 + Math.random() * 9000000000).toString();
        const finalPhoto = tempProfilePicBase64 || defaultPic;

        await set(userNode, { 
            password: uPass, 
            uid: newUid, 
            displayName: uRealName, 
            photo: finalPhoto,
            bio: "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
            premium: false
        });
        startChat(uUser, uRealName, finalPhoto, newUid, "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", false);
    }
};

function startChat(username, realName, photo, uid, bio, isAdmin) {
    myUser = { username, displayName: realName, photo, uid, bio, isAdmin, premium: myUser.premium, customId: myUser.customId, color1: myUser.color1, color2: myUser.color2 };
    
    localStorage.setItem("chat_username", username);
    localStorage.setItem("chat_password", document.getElementById("password").value);

    document.getElementById("login-screen").style.display = "none";
    document.getElementById("chat-screen").style.display = "flex";
    document.getElementById("myHeaderAvatar").src = photo;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù…ÙŠØ²
    if (myUser.premium) {
        document.getElementById("premiumHeaderBar").style.display = "block";
        document.getElementById("premiumBtn").style.display = "inline-flex";
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
    checkBanStatus();

    onChildAdded(chatRef, renderMessage);
}

async function checkBanStatus() {
    // Ø­Ø¸Ø± IP (Ù…Ø­Ø§ÙƒØ§Ø© - ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø³ØªÙƒÙˆÙ† Ù…Ù† client IP Ø­Ù‚ÙŠÙ‚ÙŠ)
    const clientIP = "127.0.0.1"; // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ IP Ø­Ù‚ÙŠÙ‚ÙŠ
    const ipBanSnap = await get(child(ipBansRef, clientIP));
    if (ipBanSnap.exists()) {
        alert("â›” IP Ù…Ø­Ø¸ÙˆØ±");
        logout();
        return;
    }

    // Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const banSnap = await get(child(bansRef, myUser.uid));
    if (banSnap.exists() && banSnap.val().until > Date.now()) {
        alert("â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ±");
        logout();
        return;
    }
}

window.logout = () => {
    localStorage.removeItem("chat_username");
    localStorage.removeItem("chat_password");
    location.reload();
};

window.sendTextMsg = async () => {
    const input = document.getElementById("msg-input");
    if(input.value.trim()) {
        await sendMessage(input.value.trim(), null);
        input.value = "";
        input.focus();
    }
};

document.getElementById("msg-input").addEventListener("keydown", (e) => {
    if(e.key === "Enter") window.sendTextMsg();
});

document.getElementById("msgImgInput").addEventListener("change", function() {
    if(this.files[0]) {
        compressImage(this.files[0], 400, 0.7, async (base64) => {
           await sendMessage(null, base64);
        });
    }
    this.value = "";
});

async function sendMessage(text, imgBase64) {
    await checkBanStatus();

    const messageData = {
        senderName: myUser.displayName,
        senderPhoto: myUser.photo,
        uid: myUser.uid,
        username: myUser.username,
        isAdmin: myUser.isAdmin,
        premium: myUser.premium,
        customId: myUser.customId,
        color1: myUser.color1,
        color2: myUser.color2,
        text: text,
        image: imgBase64,
        type: "msg",
        time: serverTimestamp()
    };

    push(chatRef, messageData);
}

function renderMessage(snap) {
    const d = snap.val();
    if (!d) return;

    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");
    
    if (d.type === "system") {
        div.style.textAlign = "center"; 
        div.style.margin = "10px 0";
        div.innerHTML = `<span style="background:rgba(200,0,0,0.3); color:#ffcccb; padding:4px 8px; border-radius:5px; font-size:11px;">ğŸ”” ${d.text}</span>`;
    } else {
        const isMe = d.uid === myUser.uid;
        div.className = `msg-row ${isMe ? 'me' : 'other'}`;
        
        const time = d.time ? new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        
        // Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø¹ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²
        let displayName = d.customId ? `<span class="premium-id">ID ${d.customId}</span>` : d.senderName;
        if (d.isAdmin) displayName = `ğŸ‘‘ ${displayName}`;
        else if (d.premium) displayName = `ğŸ‘‘ ${displayName}`;
        
        let content = "";
        if(d.text) content += `<div>${d.text}</div>`;
        if(d.image) content += `<img src="${d.image}" class="msg-img-content" onclick="window.open(this.src)">`;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¯Ø±Ø¬Ø© Ù„Ù„Ù…Ù…ÙŠØ²
        let nameStyle = d.isAdmin ? 'color:#ff4444' : 'color:var(--accent-color)';
        if (d.premium && d.color1 && d.color2) {
            const gradient = `linear-gradient(90deg, ${d.color1}, ${d.color2})`;
            nameStyle = `background: ${gradient}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%; animation: gradientShift 3s ease infinite;`;
        }

        div.innerHTML = `
            <img class="msg-avatar" src="${d.senderPhoto}" onclick="showProfile('${d.senderName}', '${d.senderPhoto}', '${d.uid}')">
            <div class="msg-content ${d.premium ? 'premium-msg' : ''}">
                <span class="msg-name" style="${nameStyle}">${displayName}</span>
                ${content}
                ${time ? `<div style="font-size:9px; opacity:0.6; text-align:left; margin-top:4px;">${time}</div>` : ''}
            </div>
        `;
    }
    
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

window.openMyProfile = async () => {
    const snap = await get(child(usersRef, myUser.username));
    if(snap.exists()) {
        myUser.bio = snap.val().bio || "";
        myUser.photo = snap.val().photo || myUser.photo;
        myUser.premium = snap.val().premium || false;
        myUser.customId = snap.val().customId || "";
    }
    showProfile(myUser.displayName, myUser.photo, myUser.uid, myUser.bio, true);
};

window.showProfile = async (name, photo, uid, bioParam = null, isMe = false) => {
    selectedUserProfile = { name, uid, photo };
    
    document.getElementById("pModalName").innerText = name;
    document.getElementById("pModalImg").src = photo;
    document.getElementById("pModalUid").innerText = `ID: ${uid}`;
    
    let bioText = bioParam || "Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Øª Ø¨Ù„Ø³";
    document.getElementById("pModalBio").innerText = bioText;

    const amITheOwner = (uid === myUser.uid);
    
    if(amITheOwner) {
        document.getElementById("editProfileTools").style.display = "block";
        document.getElementById("editBioInput").value = myUser.bio || "";
        document.getElementById("adminPanel").style.display = myUser.isAdmin ? "block" : "none";
    } else {
        document.getElementById("editProfileTools").style.display = "none";
        document.getElementById("adminPanel").style.display = myUser.isAdmin ? "block" : "none";
    }

    document.getElementById("overlay").style.display = "block";
    document.getElementById("profileModal").style.display = "block";
};

window.previewEditPic = (input) => {
    if(input.files[0]) {
        compressImage(input.files[0], 150, 0.7, (base64) => {
            tempEditPicBase64 = base64;
            document.getElementById("pModalImg").src = base64;
        });
    }
};

window.saveProfileChanges = async () => {
    const newBio = document.getElementById("editBioInput").value.trim();
    const updates = {};
    
    if(newBio) {
        updates.bio = newBio;
        myUser.bio = newBio;
    }
    
    if(tempEditPicBase64) {
        updates.photo = tempEditPicBase64;
        myUser.photo = tempEditPicBase64;
        document.getElementById("myHeaderAvatar").src = tempEditPicBase64;
    }
    
    if(Object.keys(updates).length > 0) {
        await update(child(usersRef, myUser.username), updates);
        alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
        closeModal();
    }
};

window.closeModal = () => {
    document.getElementById("profileModal").style.display = "none";
    document.getElementById("overlay").style.display = "none";
    tempEditPicBase64 = "";
};

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±Ø©
window.executeBan = async () => {
    const hours = document.getElementById("banDuration").value;
    if(!hours || !selectedUserProfile) return;
    
    const liftTime = Date.now() + (hours * 60 * 60 * 1000);
    push(chatRef, { text: `â›” ØªÙ… Ø­Ø¸Ø± ${selectedUserProfile.name} Ù„Ù…Ø¯Ø© ${hours} Ø³Ø§Ø¹Ø©`, type: "system" });
    set(child(bansRef, selectedUserProfile.uid), { until: liftTime });
    closeModal();
};

window.banIP = async () => {
    const ip = document.getElementById("banIpInput").value.trim();
    if(!ip) return;
    
    push(chatRef, { text: `ğŸŒ ØªÙ… Ø­Ø¸Ø± IP: ${ip}`, type: "system" });
    set(child(ipBansRef, ip), { bannedAt: serverTimestamp() });
    document.getElementById("banIpInput").value = "";
};

window.disableAccount = async () => {
    const targetUser = document.getElementById("disableUserInput").value.trim().toLowerCase();
    if(!targetUser) return;
    
    await update(child(usersRef, targetUser), { disabled: true });
    push(chatRef, { text: `ğŸ”’ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø­Ø³Ø§Ø¨: ${targetUser}`, type: "system" });
    document.getElementById("disableUserInput").value = "";
};
</script>
</body>
</html>
