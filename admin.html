                  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  const userSnap = await get(query(usersRef, orderByChild('uid'), equalTo(uid)));
                  if(userSnap.exists()) {
                      userSnap.forEach((childSnap) => {
                          username = childSnap.key;
                          displayName = childSnap.val().displayName;
                      });
                  }
                  
                  const daysLeft = Math.ceil((sub.premiumUntil - Date.now()) / (1000 * 60 * 60 * 24));
                  
                  const row = document.createElement("tr");
                  row.innerHTML = `
                      <td>
                          <strong>${displayName}</strong><br>
                          <small style="color:#888;">@${username}</small>
                      </td>
                      <td><code>${sub.premiumId || uid}</code></td>
                      <td>${formatDate(sub.activatedAt || sub.premiumUntil - (30 * 24 * 60 * 60 * 1000))}</td>
                      <td>${formatDate(sub.premiumUntil)}</td>
                      <td>
                          <span style="color:${daysLeft > 7 ? '#00c853' : daysLeft > 3 ? '#ff9800' : '#ff4444'}">
                              ${daysLeft > 0 ? `${daysLeft} ÙŠÙˆÙ…` : 'Ù…Ù†ØªÙ‡ÙŠ'}
                          </span>
                      </td>
                      <td>
                          <button class="btn btn-warning" onclick="extendPremium('${uid}', 30)">
                              <i class="fas fa-plus"></i> ØªØ¬Ø¯ÙŠØ¯
                          </button>
                          <button class="btn btn-danger" onclick="cancelPremium('${uid}')">
                              <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                          </button>
                      </td>
                  `;
                  
                  container.appendChild(row);
              }
          }
      }
  }

  async function loadCodes() {
      const codesSnap = await get(codesRef);
      const container = document.getElementById("used-codes-list");
      container.innerHTML = "";
      
      if(codesSnap.exists()) {
          const codesData = codesSnap.val();
          
          for(const code in codesData) {
              const codeData = codesData[code];
              
              const row = document.createElement("tr");
              row.innerHTML = `
                  <td><code>${code}</code></td>
                  <td>${codeData.usedBy || 'ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                  <td>${codeData.usedAt ? formatDate(codeData.usedAt) : 'ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                  <td>${codeData.validUntil ? formatDate(codeData.validUntil) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
              `;
              
              container.appendChild(row);
          }
      }
  }

  async function loadBans() {
      const bansSnap = await get(bansRef);
      const container = document.getElementById("bans-list");
      container.innerHTML = "";
      
      if(bansSnap.exists()) {
          const bansData = bansSnap.val();
          
          for(const uid in bansData) {
              const ban = bansData[uid];
              
              // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
              let displayName = "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ";
              const userSnap = await get(query(usersRef, orderByChild('uid'), equalTo(uid)));
              if(userSnap.exists()) {
                  userSnap.forEach((childSnap) => {
                      displayName = childSnap.val().displayName;
                  });
              }
              
              const timeLeft = ban.until > Date.now() ? formatTimeLeft(ban.until) : 'Ù…Ù†ØªÙ‡ÙŠ';
              const row = document.createElement("tr");
              row.innerHTML = `
                  <td>${displayName}<br><small style="color:#888;">ID: ${uid}</small></td>
                  <td>${ban.reason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨'}</td>
                  <td>${formatDate(ban.bannedAt || ban.until)}</td>
                  <td>
                      ${ban.until === 'permanent' ? 'Ø¯Ø§Ø¦Ù…' : 
                        ban.until > Date.now() ? formatDate(ban.until) : 'Ù…Ù†ØªÙ‡ÙŠ'}
                  </td>
                  <td>${ban.bannedBy || 'Ù†Ø¸Ø§Ù…'}</td>
                  <td>
                      ${ban.until > Date.now() ? `
                          <button class="btn btn-success" onclick="unbanUser('${uid}')">
                              <i class="fas fa-check"></i> ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
                          </button>
                      ` : ''}
                  </td>
              `;
              
              container.appendChild(row);
          }
      }
  }

  async function loadMessages() {
      const messagesSnap = await get(query(messagesRef, limitToLast(100)));
      allMessages = [];
      
      if(messagesSnap.exists()) {
          messagesSnap.forEach((childSnap) => {
              allMessages.push({
                  key: childSnap.key,
                  ...childSnap.val()
              });
          });
          
          displayMessages(allMessages);
      }
  }

  function displayMessages(messages) {
      const container = document.getElementById("messages-container");
      container.innerHTML = "";
      
      messages.reverse().forEach(msg => {
          if(msg.type === "msg") {
              const div = document.createElement("div");
              div.style.padding = "10px";
              div.style.marginBottom = "10px";
              div.style.background = "#222";
              div.style.borderRadius = "8px";
              div.style.borderLeft = "4px solid " + (msg.isPremium ? "#ffd700" : msg.isAdmin ? "#ff4444" : "#00bcd4");
              
              div.innerHTML = `
                  <div style="display:flex; justify-content:space-between;">
                      <div>
                          <strong style="color:${msg.isAdmin ? '#ff4444' : msg.isPremium ? '#ffd700' : '#00bcd4'}">
                              ${msg.isAdmin ? 'ğŸ‘‘ ' : msg.isPremium ? 'ğŸ‘‘ ' : ''}${msg.senderName}
                          </strong>
                          <small style="color:#888; margin-right:10px;">ID: ${msg.uid}</small>
                      </div>
                      <small style="color:#888;">${formatDate(msg.time, true)}</small>
                  </div>
                  <div style="margin-top:8px;">
                      ${msg.text ? `<p>${msg.text}</p>` : ''}
                      ${msg.image ? `<img src="${msg.image}" style="max-width:200px; border-radius:5px; margin-top:5px;">` : ''}
                  </div>
                  <button class="btn btn-danger" style="font-size:10px; padding:3px 8px; margin-top:5px;" 
                          onclick="deleteMessage('${msg.key}')">
                      <i class="fas fa-trash"></i> Ø­Ø°Ù
                  </button>
              `;
              
              container.appendChild(div);
          }
      });
  }

  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  window.openTab = (tabName) => {
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
      document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
      });
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
      });
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
      event.target.classList.add('active');
      
      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¥Ø°Ø§ Ù„Ø²Ù…
      if(tabName === 'users') loadUsers();
      if(tabName === 'premium') loadPremiumSubscriptions();
      if(tabName === 'bans') loadBans();
      if(tabName === 'messages') loadMessages();
  };

  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  window.filterUsers = () => {
      const searchTerm = document.getElementById('search-user').value.toLowerCase();
      const filtered = allUsers.filter(user => 
          user.displayName.toLowerCase().includes(searchTerm) ||
          user.username.toLowerCase().includes(searchTerm) ||
          user.uid.includes(searchTerm) ||
          (user.bio && user.bio.toLowerCase().includes(searchTerm))
      );
      
      displayUsers(filtered);
  };

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©
  window.openAddPremiumModal = () => {
      document.getElementById('add-premium-modal').style.display = 'flex';
  };

  window.addPremiumSubscription = async () => {
      const username = document.getElementById('add-premium-username').value.trim();
      const days = parseInt(document.getElementById('add-premium-days').value) || 30;
      const customId = document.getElementById('add-premium-id').value.trim();
      
      if(!username) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
          return;
      }
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userSnap = await get(child(usersRef, username));
      if(!userSnap.exists()) {
          alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
      }
      
      const userData = userSnap.val();
      const premiumUntil = Date.now() + (days * 24 * 60 * 60 * 1000);
      
      await set(child(premiumRef, userData.uid), {
          isPremium: true,
          premiumUntil: premiumUntil,
          premiumId: customId || userData.uid,
          premiumGradient: 1,
          activatedAt: Date.now(),
          activatedBy: currentUser.username,
          manualAdd: true
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
      await set(child(ref(db, 'messages'), Date.now().toString()), {
          text: `ğŸ‰ ${userData.displayName} Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù…ÙŠØ² Ù„Ù…Ø¯Ø© ${days} ÙŠÙˆÙ…!`,
          type: "system",
          time: Date.now()
      });
      
      closeModal();
      loadPremiumSubscriptions();
      updateStats();
      
      await logEvent('Ø§Ø´ØªØ±Ø§Ùƒ', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù…ÙŠØ² Ù„Ù€ ${username} Ù„Ù…Ø¯Ø© ${days} ÙŠÙˆÙ…`);
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù…ÙŠØ² Ø¨Ù†Ø¬Ø§Ø­');
  };

  window.extendPremium = async (uid, days) => {
      const premiumSnap = await get(child(premiumRef, uid));
      if(premiumSnap.exists()) {
          const data = premiumSnap.val();
          const newUntil = Math.max(data.premiumUntil, Date.now()) + (days * 24 * 60 * 60 * 1000);
          
          await update(child(premiumRef, uid), {
              premiumUntil: newUntil
          });
          
          loadPremiumSubscriptions();
          await logEvent('Ø§Ø´ØªØ±Ø§Ùƒ', `ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§Ùƒ ${uid} Ù„Ù…Ø¯Ø© ${days} ÙŠÙˆÙ…`);
          alert('ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
      }
  };

  window.cancelPremium = async (uid) => {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ù…ÙŠØ²ØŸ')) {
          await update(child(premiumRef, uid), {
              isPremium: false
          });
          
          loadPremiumSubscriptions();
          updateStats();
          await logEvent('Ø§Ø´ØªØ±Ø§Ùƒ', `ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ ${uid}`);
          alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
      }
  };

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
  window.generateCodes = async () => {
      const count = parseInt(document.getElementById('code-count').value) || 5;
      const days = parseInt(document.getElementById('code-days').value) || 30;
      
      const codesContainer = document.getElementById('generated-codes');
      codesContainer.innerHTML = '<h3>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©:</h3>';
      
      for(let i = 0; i < count; i++) {
          const code = generateCode();
          const validUntil = Date.now() + (days * 24 * 60 * 60 * 1000);
          
          // Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          await set(child(codesRef, code), {
              generatedAt: Date.now(),
              validUntil: validUntil,
              generatedBy: currentUser.username,
              daysValid: days
          });
          
          const codeDiv = document.createElement('div');
          codeDiv.className = 'code-display';
          codeDiv.textContent = code;
          codeDiv.style.cursor = 'pointer';
          codeDiv.onclick = () => {
              navigator.clipboard.writeText(code);
              alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: ' + code);
          };
          
          codesContainer.appendChild(codeDiv);
      }
      
      await logEvent('Ø£ÙƒÙˆØ§Ø¯', `ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${count} ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ`);
      alert(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${count} ÙƒÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­`);
  };

  function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const sections = [];
      
      for(let i = 0; i < 5; i++) {
          let section = '';
          for(let j = 0; j < 4; j++) {
              section += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          sections.push(section);
      }
      
      return `FAI-TRIAL-${sections.join('-')}`;
  }

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¸Ø±
  window.banUser = async () => {
      const usernameOrId = document.getElementById('ban-username').value.trim();
      const duration = document.getElementById('ban-duration').value;
      const reason = document.getElementById('ban-reason').value.trim() || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨';
      
      if(!usernameOrId) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ID');
          return;
      }
      
      let uid = null;
      let displayName = '';
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if(usernameOrId.startsWith('@')) {
          const userSnap = await get(child(usersRef, usernameOrId.substring(1)));
          if(userSnap.exists()) {
              uid = userSnap.val().uid;
              displayName = userSnap.val().displayName;
          }
      } else {
          // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID
          const userSnap = await get(query(usersRef, orderByChild('uid'), equalTo(usernameOrId)));
          if(userSnap.exists()) {
              userSnap.forEach((childSnap) => {
                  uid = childSnap.val().uid;
                  displayName = childSnap.val().displayName;
              });
          }
      }
      
      if(!uid) {
          alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
      }
      
      const banData = {
          reason: reason,
          bannedBy: currentUser.username,
          bannedAt: Date.now()
      };
      
      if(duration === 'permanent') {
          banData.until = 'permanent';
      } else {
          const hours = parseInt(duration);
          banData.until = Date.now() + (hours * 60 * 60 * 1000);
      }
      
      await set(child(bansRef, uid), banData);
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
      await set(child(ref(db, 'messages'), Date.now().toString()), {
          text: `â›” ${displayName} ØªÙ… Ø­Ø¸Ø±Ù‡ ${duration === 'permanent' ? 'Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…' : `Ù„Ù…Ø¯Ø© ${duration} Ø³Ø§Ø¹Ø©`} - Ø§Ù„Ø³Ø¨Ø¨: ${reason}`,
          type: "system",
          time: Date.now()
      });
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('ban-username').value = '';
      document.getElementById('ban-reason').value = '';
      
      loadBans();
      updateStats();
      
      await logEvent('Ø­Ø¸Ø±', `ØªÙ… Ø­Ø¸Ø± ${displayName} (${uid}) - Ø§Ù„Ø³Ø¨Ø¨: ${reason}`);
      alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
  };

  window.unbanUser = async (uid) => {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙÙƒ Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
          await remove(child(bansRef, uid));
          
          loadBans();
          updateStats();
          
          await logEvent('Ø­Ø¸Ø±', `ØªÙ… ÙÙƒ Ø­Ø¸Ø± ${uid}`);
          alert('ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¨Ù†Ø¬Ø§Ø­');
      }
  };

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  window.searchMessages = () => {
      const searchTerm = document.getElementById('message-search').value.toLowerCase();
      const filtered = allMessages.filter(msg => 
          msg.type === "msg" && (
              msg.text?.toLowerCase().includes(searchTerm) ||
              msg.senderName?.toLowerCase().includes(searchTerm) ||
              msg.uid?.includes(searchTerm)
          )
      );
      
      displayMessages(filtered);
  };

  window.deleteMessage = async (messageKey) => {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
          await remove(child(messagesRef, messageKey));
          
          loadMessages();
          await logEvent('Ø±Ø³Ø§Ø¦Ù„', `ØªÙ… Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ${messageKey}`);
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
      }
  };

  window.clearMessages = async () => {
      if(confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
          await remove(messagesRef);
          
          loadMessages();
          await logEvent('Ø±Ø³Ø§Ø¦Ù„', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
          alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
  };

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  window.editUser = async (username) => {
      const userSnap = await get(child(usersRef, username));
      if(userSnap.exists()) {
          const user = userSnap.val();
          
          const modalContent = `
              <div class="form-group">
                  <label style="color:#ccc;">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶:</label>
                  <input type="text" id="edit-display-name" class="form-control" value="${user.displayName}">
              </div>
              
              <div class="form-group">
                  <label style="color:#ccc;">Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©:</label>
                  <textarea id="edit-bio" class="form-control" rows="3">${user.bio || ''}</textarea>
              </div>
              
              <div class="form-group">
                  <label style="color:#ccc;">
                      <input type="checkbox" id="edit-is-admin" ${user.isAdmin ? 'checked' : ''}>
                      ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
                  </label>
              </div>
              
              <div class="form-group">
                  <label style="color:#ccc;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©):</label>
                  <input type="password" id="edit-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
              </div>
              
              <button class="btn btn-success" onclick="saveUserChanges('${username}')" style="width:100%;">
                  <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
              </button>
              
              <button class="btn btn-danger" onclick="forceLogout('${username}')" style="width:100%; margin-top:10px;">
                  <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù‚Ø³Ø±ÙŠ
              </button>
          `;
          
          document.getElementById('edit-user-content').innerHTML = modalContent;
          document.getElementById('edit-user-modal').style.display = 'flex';
      }
  };

  window.saveUserChanges = async (username) => {
      const updates = {};
      const displayName = document.getElementById('edit-display-name').value.trim();
      const bio = document.getElementById('edit-bio').value.trim();
      const isAdmin = document.getElementById('edit-is-admin').checked;
      const password = document.getElementById('edit-password').value.trim();
      
      if(displayName) updates.displayName = displayName;
      if(bio !== undefined) updates.bio = bio;
      updates.isAdmin = isAdmin;
      if(password) updates.password = password;
      
      await update(child(usersRef, username), updates);
      
      closeModal();
      loadUsers();
      
      await logEvent('Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${username}`);
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  };

  window.deleteUser = async (username) => {
      if(confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
          const userSnap = await get(child(usersRef, username));
          if(userSnap.exists()) {
              const uid = userSnap.val().uid;
              
              // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
              await remove(child(usersRef, username));
              
              // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†
              await remove(child(premiumRef, uid));
              
              // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
              await remove(child(bansRef, uid));
              
              loadUsers();
              loadPremiumSubscriptions();
              loadBans();
              updateStats();
              
              await logEvent('Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…`);
              alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
          }
      }
  };

  window.forceLogout = async (username) => {
      // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø¬Ø¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
      // ÙŠÙ…ÙƒÙ† ØªØ­Ù‚ÙŠÙ‚ Ø°Ù„Ùƒ Ø¨Ø¥Ø¶Ø§ÙØ© token Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡
      
      await logEvent('Ø¬Ù„Ø³Ø§Øª', `ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± ${username} Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬`);
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
  };

  // Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø«
  async function logEvent(type, message) {
      const logEntry = {
          type: type,
          message: message,
          admin: currentUser.username,
          timestamp: Date.now()
      };
      
      await push(logsRef, logEntry);
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      const logsDiv = document.getElementById('admin-logs');
      const logDiv = document.createElement('div');
      logDiv.className = 'log-entry';
      logDiv.innerHTML = `
          <span class="log-time">[${new Date().toLocaleString()}]</span>
          <span class="log-${type === 'Ø®Ø·Ø£' ? 'error' : type === 'Ù†Ø¬Ø§Ø­' ? 'success' : 'info'}">
              ${message}
          </span>
      `;
      
      logsDiv.prepend(logDiv);
  }

  window.exportLogs = async () => {
      const logsSnap = await get(logsRef);
      let logsText = "Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯Ù…Ù† - Ø´Ø§Øª Ø¨Ù„Ø³\n";
      logsText += "=".repeat(50) + "\n\n";
      
      if(logsSnap.exists()) {
          const logs = [];
          logsSnap.forEach((childSnap) => {
              logs.push(childSnap.val());
          });
          
          logs.sort((a, b) => b.timestamp - a.timestamp);
          
          logs.forEach(log => {
              logsText += `[${new Date(log.timestamp).toLocaleString()}] ${log.type}: ${log.message} (Ø¨ÙˆØ§Ø³Ø·Ø©: ${log.admin})\n`;
          });
      }
      
      const blob = new Blob([logsText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
  };

  window.clearLogs = async () => {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ')) {
          await remove(logsRef);
          document.getElementById('admin-logs').innerHTML = `
              <div class="log-entry">
                  <span class="log-time">[${new Date().toLocaleString()}]</span>
                  <span class="log-info"> ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
              </div>
          `;
          
          await logEvent('Ø³Ø¬Ù„Ø§Øª', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
      }
  };

  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  window.saveSecuritySettings = () => {
      const maxAttempts = document.getElementById('max-attempts').value;
      const lockDuration = document.getElementById('lock-duration').value;
      
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø©
      localStorage.setItem('admin_maxAttempts', maxAttempts);
      localStorage.setItem('admin_lockDuration', lockDuration);
      
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
  };

  window.resetSystem = async () => {
      if(confirm('âš ï¸ ØªØ­Ø°ÙŠØ± Ø´Ø¯ÙŠØ¯: Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
          if(prompt('Ø§ÙƒØªØ¨ "ØªØ£ÙƒÙŠØ¯" Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:') === 'ØªØ£ÙƒÙŠØ¯') {
              // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ ÙƒÙ† Ø­Ø°Ø±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹)
              await Promise.all([
                  remove(usersRef),
                  remove(premiumRef),
                  remove(bansRef),
                  remove(messagesRef),
                  remove(codesRef)
              ]);
              
              // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†
              await set(child(usersRef, "texn"), {
                  password: "hamzagmail34567",
                  uid: "1111",
                  displayName: "ğ‘ğ„ğŒğ€ğ’ à¼—",
                  photo: "https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg",
                  bio: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…",
                  isAdmin: true,
                  joinedAt: Date.now()
              });
              
              await logEvent('Ù†Ø¸Ø§Ù…', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
              alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
              location.reload();
          }
      }
  };

  window.deleteInactiveUsers = async () => {
      const cutoffDate = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30 ÙŠÙˆÙ…
      let deletedCount = 0;
      
      const usersSnap = await get(usersRef);
      if(usersSnap.exists()) {
          const users = usersSnap.val();
          
          for(const username in users) {
              if(username === "texn") continue; // Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù†
              
              const user = users[username];
              const lastActive = user.lastActive || user.joinedAt;
              
              if(lastActive < cutoffDate) {
                  const uid = user.uid;
                  
                  // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                  await remove(child(usersRef, username));
                  
                  // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                  await remove(child(premiumRef, uid));
                  await remove(child(bansRef, uid));
                  
                  deletedCount++;
              }
          }
      }
      
      await logEvent('Ù†Ø¸Ø§ÙØ©', `ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù†Ø´Ø·`);
      alert(`ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù†Ø´Ø·`);
      loadUsers();
      updateStats();
  };

  // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
  function formatDate(timestamp, showTime = false) {
      if(!timestamp) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      
      const date = new Date(parseInt(timestamp));
      if(showTime) {
          return date.toLocaleString('ar-SA');
      }
      return date.toLocaleDateString('ar-SA');
  }

  function formatTimeLeft(timestamp) {
      const diff = timestamp - Date.now();
      if(diff <= 0) return 'Ù…Ù†ØªÙ‡ÙŠ';
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      
      if(days > 0) return `${days} ÙŠÙˆÙ… Ùˆ ${hours} Ø³Ø§Ø¹Ø©`;
      return `${hours} Ø³Ø§Ø¹Ø©`;
  }

  function setupRealtimeUpdates() {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      onValue(usersRef, updateStats);
      onValue(premiumRef, updateStats);
      onValue(bansRef, updateStats);
      onValue(messagesRef, () => {
          loadMessages();
          updateStats();
      });
      
      // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      onValue(usersRef, loadUsers);
      onValue(premiumRef, loadPremiumSubscriptions);
      onValue(bansRef, loadBans);
      onValue(codesRef, loadCodes);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      onValue(logsRef, (snap) => {
          const logsDiv = document.getElementById('admin-logs');
          if(snap.exists()) {
              const logs = [];
              snap.forEach((childSnap) => {
                  logs.push(childSnap.val());
              });
              
              logs.sort((a, b) => b.timestamp - a.timestamp);
              
              let logsHTML = '';
              logs.slice(0, 50).forEach(log => {
                  const logClass = log.type === 'Ø®Ø·Ø£' ? 'log-error' : 
                                 log.type === 'Ù†Ø¬Ø§Ø­' ? 'log-success' : 'log-info';
                  logsHTML += `
                      <div class="log-entry">
                          <span class="log-time">[${new Date(log.timestamp).toLocaleString()}]</span>
                          <span class="${logClass}">${log.message}</span>
                      </div>
                  `;
              });
              
              logsDiv.innerHTML = logsHTML;
          }
      });
  }

  window.refreshAll = () => {
      loadDashboard();
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  };

  window.closeModal = () => {
      document.querySelectorAll('.modal').forEach(modal => {
          modal.style.display = 'none';
      });
  };

  window.logout = () => {
      localStorage.removeItem('admin_user');
      localStorage.removeItem('admin_pass');
      window.location.href = 'index.html';
  };
</script>
</body>
</html>
